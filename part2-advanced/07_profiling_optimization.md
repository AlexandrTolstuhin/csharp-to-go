# 2.7 ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

## Ğ¡Ğ¾Ğ´ĞµÑ€Ğ¶Ğ°Ğ½Ğ¸Ğµ
- [Ğ’Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ](#Ğ²Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ)
- [1. pprof: CPU Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ](#1-pprof-cpu-Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ)
  - [1.1 ĞšĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ CPU sampling](#11-ĞºĞ°Ğº-Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚-cpu-sampling)
  - [1.2 ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ pprof Ğº Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ](#12-Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ-pprof-Ğº-Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ)
  - [1.3 Ğ¡Ğ±Ğ¾Ñ€ CPU Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ](#13-ÑĞ±Ğ¾Ñ€-cpu-Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ)
  - [1.4 ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ: Ğ¸Ğ½Ñ‚ĞµÑ€Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼](#14-Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·-Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ-Ğ¸Ğ½Ñ‚ĞµÑ€Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹-Ñ€ĞµĞ¶Ğ¸Ğ¼)
  - [1.5 Flame Graphs](#15-flame-graphs)
  - [1.6 Ğ¢Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ñ‹Ğµ CPU bottlenecks](#16-Ñ‚Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ñ‹Ğµ-cpu-bottlenecks)
- [2. go tool trace: Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·](#2-go-tool-trace-Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğ¹-Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·)
  - [2.1 ĞšĞ¾Ğ³Ğ´Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ trace vs pprof](#21-ĞºĞ¾Ğ³Ğ´Ğ°-Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ-trace-vs-pprof)
  - [2.2 Ğ¡Ğ±Ğ¾Ñ€ Ğ¸ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ trace](#22-ÑĞ±Ğ¾Ñ€-Ğ¸-Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ-trace)
  - [2.3 ĞĞ½Ğ°Ğ»Ğ¸Ğ· Goroutine Analysis](#23-Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·-goroutine-analysis)
  - [2.4 Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° latency spikes](#24-Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°-latency-spikes)
- [3. ĞšĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑĞ½Ñ‹Ğ¹ workflow Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ](#3-ĞºĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑĞ½Ñ‹Ğ¹-workflow-Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ)
  - [3.1 ĞœĞµÑ‚Ğ¾Ğ´Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ: Measure â†’ Identify â†’ Optimize â†’ Verify](#31-Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ-measure--identify--optimize--verify)
  - [3.2 Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ° Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹](#32-Ğ²Ñ‹Ğ±Ğ¾Ñ€-Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ°-Ğ¿Ğ¾-Ñ‚Ğ¸Ğ¿Ñƒ-Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹)
  - [3.3 Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ CI/CD](#33-Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ-Ñ-cicd)
- [4. ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ production-ĞºĞ¾Ğ´Ğ°](#4-Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ-production-ĞºĞ¾Ğ´Ğ°)
  - [4.1 Hot paths Ğ¸ Ğ·Ğ°ĞºĞ¾Ğ½ ĞĞ¼Ğ´Ğ°Ğ»Ğ°](#41-hot-paths-Ğ¸-Ğ·Ğ°ĞºĞ¾Ğ½-Ğ°Ğ¼Ğ´Ğ°Ğ»Ğ°)
  - [4.2 ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ¾Ğ²Ñ‹Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹](#42-Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ-ÑÑ‚Ñ€Ğ¾ĞºĞ¾Ğ²Ñ‹Ñ…-Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹)
  - [4.3 ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ JSON](#43-Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ-json)
  - [4.4 Ğ˜Ğ·Ğ±ĞµĞ³Ğ°Ğ½Ğ¸Ğµ interface{} Ğ² hot paths](#44-Ğ¸Ğ·Ğ±ĞµĞ³Ğ°Ğ½Ğ¸Ğµ-interface-Ğ²-hot-paths)
  - [4.5 Preallocations Ğ¸ Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ](#45-preallocations-Ğ¸-Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ)
- [5. Continuous Profiling](#5-continuous-profiling)
  - [5.1 ĞšĞ¾Ğ½Ñ†ĞµĞ¿Ñ†Ğ¸Ñ](#51-ĞºĞ¾Ğ½Ñ†ĞµĞ¿Ñ†Ğ¸Ñ)
  - [5.2 Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹](#52-Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹)
  - [5.3 Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ Go Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµĞ¼](#53-Ğ¸Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ-Ñ-go-Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµĞ¼)
- [ĞŸÑ€Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹](#Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ-Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹)
  - [ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 1: ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ HTTP ÑĞµÑ€Ğ²Ğ¸ÑĞ° (end-to-end)](#Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€-1-Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ-http-ÑĞµÑ€Ğ²Ğ¸ÑĞ°-end-to-end)
  - [ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 2: Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° memory leak Ñ‡ĞµÑ€ĞµĞ· goroutine leak](#Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€-2-Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°-memory-leak-Ñ‡ĞµÑ€ĞµĞ·-goroutine-leak)
  - [ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 3: Latency spikes Ğ² Ğ¼Ğ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑĞµ](#Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€-3-latency-spikes-Ğ²-Ğ¼Ğ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑĞµ)
  - [ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 4: CI/CD pipeline Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸](#Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€-4-cicd-pipeline-Ğ´Ğ»Ñ-Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸)
- [Ğ§ĞµĞº-Ğ»Ğ¸ÑÑ‚](#Ñ‡ĞµĞº-Ğ»Ğ¸ÑÑ‚)

---

## Ğ’Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ

Ğ’ Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ñ… Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ°Ñ… Ğ¼Ñ‹ Ğ¸Ğ·ÑƒÑ‡Ğ¸Ğ»Ğ¸ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ°ÑĞ¿ĞµĞºÑ‚Ñ‹ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Go:
- [Ğ Ğ°Ğ·Ğ´ĞµĞ» 2.3 (GC)](./03_gc.md) â€” pprof Ğ´Ğ»Ñ memory profiling, escape analysis, `GOGC`/`GOMEMLIMIT`
- [Ğ Ğ°Ğ·Ğ´ĞµĞ» 2.6 (Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ)](./06_testing_benchmarking.md) â€” benchmarks, `benchstat`, race detector

Ğ­Ñ‚Ğ¾Ñ‚ Ñ€Ğ°Ğ·Ğ´ĞµĞ» Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµÑ‚ Ğ²ÑĞµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ² **ĞµĞ´Ğ¸Ğ½Ñ‹Ğ¹ workflow Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ** Ğ¸ Ñ„Ğ¾ĞºÑƒÑĞ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ½Ğ°:
- **CPU Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ** (Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ñ„Ğ¾ĞºÑƒÑ â€” Ğ½Ğµ Ñ€Ğ°ÑÑĞ¼Ğ°Ñ‚Ñ€Ğ¸Ğ²Ğ°Ğ»Ğ¾ÑÑŒ Ñ€Ğ°Ğ½ĞµĞµ)
- **ĞšĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑĞ½Ğ°Ñ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ** "Ğ¾Ñ‚ ÑĞ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼Ğ° Ğº Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ"
- **ĞŸÑ€Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸** production-ĞºĞ¾Ğ´Ğ°
- **Continuous Profiling** Ğ´Ğ»Ñ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° Ğ² production

> ğŸ’¡ **Ğ”Ğ»Ñ C# Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‡Ğ¸ĞºĞ¾Ğ²**: Ğ’ .NET ÑĞºĞ¾ÑĞ¸ÑÑ‚ĞµĞ¼Ğµ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ğ¾ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ñ… Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² (dotTrace, dotMemory, ANTS Profiler) Ğ¸Ğ»Ğ¸ ÑĞ»Ğ¾Ğ¶Ğ½Ğ¾Ğ¹ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ (PerfView, ETW). Ğ’ Go Ğ²ÑĞµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ²ÑÑ‚Ñ€Ğ¾ĞµĞ½Ñ‹ Ğ¸ Ğ±ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹ â€” `pprof`, `go tool trace`, `go test -bench`. Ğ¤Ğ¸Ğ»Ğ¾ÑĞ¾Ñ„Ğ¸Ñ Ñ‚Ğ° Ğ¶Ğµ: **Ğ½Ğµ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€ÑƒĞ¹ Ğ±ĞµĞ· Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ñ‰Ğ¸ĞºĞ°**.

### Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ°: .NET Profiling vs Go Profiling

| ĞÑĞ¿ĞµĞºÑ‚ | .NET | Go |
|--------|------|-----|
| **CPU Profiling** | Visual Studio Profiler, dotTrace, PerfView | `pprof` CPU profile |
| **Memory Profiling** | dotMemory, PerfView, VS Diagnostic Tools | `pprof` heap/allocs ([Ñ€Ğ°Ğ·Ğ´ĞµĞ» 2.3](./03_gc.md)) |
| **Concurrency** | Concurrency Visualizer (VS Enterprise) | `go tool trace` |
| **Benchmarks** | BenchmarkDotNet (NuGet) | `go test -bench` (Ğ²ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğ¹) |
| **Race Detection** | Thread Sanitizer (LLVM, Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğ¹) | `go test -race` (Ğ²ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğ¹) |
| **Flame Graphs** | PerfView, speedscope | `pprof -http` (Ğ²ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğ¹) |
| **Production Profiling** | Application Insights, Datadog | Pyroscope, Cloud Profiler |
| **Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ** | Ğ§Ğ°ÑÑ‚Ğ¾ Ğ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ğµ (dotTrace ~$400/Ğ³Ğ¾Ğ´) | Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾ |
| **Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ IDE** | ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ°Ñ (VS, Rider) | Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ (GoLand), CLI-first |

### Ğ—Ğ¾Ğ»Ğ¾Ñ‚Ğ¾Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»Ğ¾ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘   "Premature optimization is the root of all evil"           â•‘
â•‘                                    â€” Donald Knuth             â•‘
â•‘                                                               â•‘
â•‘   ĞĞ:                                                         â•‘
â•‘   "Ğ˜Ğ·Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ğµ Ğ±ĞµĞ· Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ â€” Ğ¿Ğ¾Ñ‚ĞµÑ€Ñ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸"               â•‘
â•‘   "ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±ĞµĞ· Ğ¸Ğ·Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ñ â€” Ğ³Ğ°Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğ° ĞºĞ¾Ñ„ĞµĞ¹Ğ½Ğ¾Ğ¹ Ğ³ÑƒÑ‰Ğµ"     â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´:**
1. **Measure** â€” ÑĞ¾Ğ±ĞµÑ€Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ñ‰Ğ¸ĞºĞ°
2. **Identify** â€” Ğ½Ğ°Ğ¹Ğ´Ğ¸ bottleneck
3. **Optimize** â€” Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸ ĞºĞ¾Ğ´
4. **Verify** â€” Ğ¿Ğ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ğµ Ñ‡ĞµÑ€ĞµĞ· benchstat

---

## 1. pprof: CPU Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

CPU Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ â€” ÑÑ‚Ğ¾ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ½Ğ° Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ **"Ğ“Ğ´Ğµ Ğ¼Ğ¾Ñ‘ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ñ‚Ñ€Ğ°Ñ‚Ğ¸Ñ‚ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ñ€Ğ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ?"**

> ğŸ’¡ **Ğ¡Ğ²ÑĞ·ÑŒ Ñ Ğ´Ñ€ÑƒĞ³Ğ¸Ğ¼Ğ¸ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ°Ğ¼Ğ¸**: Memory profiling Ñ‡ĞµÑ€ĞµĞ· pprof Ğ¿Ğ¾Ğ´Ñ€Ğ¾Ğ±Ğ½Ğ¾ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½ Ğ² [Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğµ 2.3 (GC)](./03_gc.md). Ğ—Ğ´ĞµÑÑŒ Ñ„Ğ¾ĞºÑƒÑĞ¸Ñ€ÑƒĞµĞ¼ÑÑ Ğ½Ğ° CPU.

### 1.1 ĞšĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ CPU sampling

Go Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ **sampling-based Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   CPU SAMPLING                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚   Ğ’Ñ€ĞµĞ¼Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º     â”‚
â”‚                                                              â”‚
â”‚   ĞŸÑ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ°:  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ        â”‚
â”‚                  â–²         â–²           â–²        â–²           â”‚
â”‚                  â”‚         â”‚           â”‚        â”‚           â”‚
â”‚   Samples:      [1]       [2]         [3]      [4]          â”‚
â”‚                  â”‚         â”‚           â”‚        â”‚           â”‚
â”‚                  â–¼         â–¼           â–¼        â–¼           â”‚
â”‚   Stack:     main()   process()   process()   main()        â”‚
â”‚              parse()   compute()  compute()   write()       â”‚
â”‚              read()    math()     math()      flush()       â”‚
â”‚                                                              â”‚
â”‚   Ğ§Ğ°ÑÑ‚Ğ¾Ñ‚Ğ°: 100 samples/sec (ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ 10ms)                    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ĞšĞ°Ğº ÑÑ‚Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚:**
1. ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ñ‰Ğ¸Ğº ĞºĞ°Ğ¶Ğ´Ñ‹Ğµ ~10ms Ğ¾ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ
2. Ğ—Ğ°Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ call stack Ğ²ÑĞµÑ… Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½
3. ĞŸĞ¾ÑĞ»Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ¸Ñ Ğ°Ğ³Ñ€ĞµĞ³Ğ¸Ñ€ÑƒĞµÑ‚: ĞºĞ°ĞºĞ¸Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ñ‡Ğ°Ñ‰Ğµ Ğ²ÑĞµĞ³Ğ¾ Ğ±Ñ‹Ğ»Ğ¸ Ğ½Ğ° ÑÑ‚ĞµĞºĞµ

**ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ° sampling:**
- ĞĞ¸Ğ·ĞºĞ¸Ğ¹ overhead (~5-10%)
- ĞĞµ Ğ¸ÑĞºĞ°Ğ¶Ğ°ĞµÑ‚ Ğ¿Ğ¾Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹
- Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ñ‚Ğ¾Ñ‡ĞµĞ½ Ğ¿Ñ€Ğ¸ Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾Ğ¼ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ ÑĞ±Ğ¾Ñ€Ğ°

**Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ .NET:**

| ĞÑĞ¿ĞµĞºÑ‚ | .NET (dotTrace) | Go (pprof) |
|--------|-----------------|------------|
| ĞœĞµÑ‚Ğ¾Ğ´ | Sampling + Tracing | Sampling only |
| Ğ§Ğ°ÑÑ‚Ğ¾Ñ‚Ğ° | ĞĞ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼Ğ°Ñ | 100 Hz (Ñ„Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ) |
| Overhead | 5-50% (Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğ°) | ~5-10% |
| Line-level | Ğ”Ğ° (Ğ² tracing mode) | Ğ”Ğ° |

### 1.2 ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ pprof Ğº Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ

#### Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ± 1: HTTP endpoint (Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ²)

```go
package main

import (
    "log"
    "net/http"
    _ "net/http/pprof" // Ğ’Ğ°Ğ¶Ğ½Ğ¾: blank import!
)

func main() {
    // Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞµÑ‚ endpoints:
    // /debug/pprof/
    // /debug/pprof/profile     <- CPU profile
    // /debug/pprof/heap        <- Memory profile
    // /debug/pprof/goroutine   <- Goroutine stacks
    // /debug/pprof/block       <- Block profile
    // /debug/pprof/mutex       <- Mutex profile
    // /debug/pprof/trace       <- Execution trace

    // ĞĞ¿Ñ†Ğ¸Ñ 1: ĞÑ‚Ğ´ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ¾Ñ€Ñ‚ Ğ´Ğ»Ñ pprof (Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒĞµÑ‚ÑÑ Ğ´Ğ»Ñ production)
    go func() {
        log.Println("pprof server: http://localhost:6060/debug/pprof/")
        log.Println(http.ListenAndServe("localhost:6060", nil))
    }()

    // Ğ’Ğ°Ñˆ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¾Ğ¹ ÑĞµÑ€Ğ²ĞµÑ€
    mux := http.NewServeMux()
    mux.HandleFunc("/api/users", handleUsers)

    log.Fatal(http.ListenAndServe(":8080", mux))
}
```

> âš ï¸ **Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ**: ĞĞ¸ĞºĞ¾Ğ³Ğ´Ğ° Ğ½Ğµ ÑĞºÑĞ¿Ğ¾Ğ½Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ pprof endpoint Ğ² Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ½ĞµÑ‚! ĞĞ½ Ñ€Ğ°ÑĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½ÑÑ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ğ¸ Ğ¼Ğ¾Ğ¶ĞµÑ‚ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ² stack traces.

**Ğ—Ğ°Ñ‰Ğ¸Ñ‚Ğ° pprof Ğ² production:**

```go
// Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ 1: Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ localhost
http.ListenAndServe("localhost:6060", nil)

// Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ 2: Middleware Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸ĞµĞ¹
func pprofAuth(next http.Handler) http.Handler {
    return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
        token := r.Header.Get("X-Pprof-Token")
        if token != os.Getenv("PPROF_TOKEN") {
            http.Error(w, "Unauthorized", http.StatusUnauthorized)
            return
        }
        next.ServeHTTP(w, r)
    })
}
```

#### Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ± 2: ĞŸÑ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ½Ñ‹Ğ¹ ÑĞ±Ğ¾Ñ€ (Ğ´Ğ»Ñ CLI, benchmarks)

```go
package main

import (
    "os"
    "runtime/pprof"
)

func main() {
    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ñ„Ğ°Ğ¹Ğ» Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ
    f, err := os.Create("cpu.prof")
    if err != nil {
        panic(err)
    }
    defer f.Close()

    // ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
    if err := pprof.StartCPUProfile(f); err != nil {
        panic(err)
    }
    defer pprof.StopCPUProfile()

    // Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ ĞºĞ¾Ğ´, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ñ…Ğ¾Ñ‚Ğ¸Ğ¼ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ
    runExpensiveOperation()
}
```

#### Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ± 3: ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ benchmarks (ÑĞ°Ğ¼Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¹)

```bash
# Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ benchmark Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ CPU Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ
go test -bench=BenchmarkProcess -cpuprofile=cpu.prof

# Ğ¢Ğ°ĞºĞ¶Ğµ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ ÑĞ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ memory Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ
go test -bench=BenchmarkProcess -memprofile=mem.prof
```

### 1.3 Ğ¡Ğ±Ğ¾Ñ€ CPU Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ

#### Ğ§ĞµÑ€ĞµĞ· HTTP endpoint

```bash
# Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ 30-ÑĞµĞºÑƒĞ½Ğ´Ğ½Ñ‹Ğ¹ CPU Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ
go tool pprof http://localhost:6060/debug/pprof/profile?seconds=30

# Ğ˜Ğ»Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ² Ñ„Ğ°Ğ¹Ğ»
curl -o cpu.prof "http://localhost:6060/debug/pprof/profile?seconds=30"
```

#### ĞœĞ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ²Ñ€ĞµĞ¼Ñ ÑĞ±Ğ¾Ñ€Ğ°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Ğ Ğ•ĞšĞĞœĞ•ĞĞ”Ğ£Ğ•ĞœĞĞ• Ğ’Ğ Ğ•ĞœĞ¯ Ğ¡Ğ‘ĞĞ Ğ                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹                    â”‚ Ğ’Ñ€ĞµĞ¼Ñ                      â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚
â”‚   Benchmark, Ğ¼Ğ¸ĞºÑ€Ğ¾-Ñ‚ĞµÑÑ‚       â”‚ 5-10 ÑĞµĞºÑƒĞ½Ğ´                â”‚
â”‚   Ğ¢Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ production         â”‚ 30 ÑĞµĞºÑƒĞ½Ğ´                  â”‚
â”‚   Ğ ĞµĞ´ĞºĞ¸Ğµ ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ              â”‚ 60-120 ÑĞµĞºÑƒĞ½Ğ´              â”‚
â”‚   ĞŸĞ¾Ğ¸ÑĞº intermittent issues   â”‚ 5-10 Ğ¼Ğ¸Ğ½ÑƒÑ‚                 â”‚
â”‚                                                             â”‚
â”‚   ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»Ğ¾: Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 1000 samples Ğ´Ğ»Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ¸             â”‚
â”‚   100 Hz Ã— 30 sec = 3000 samples âœ“                         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.4 ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ: Ğ¸Ğ½Ñ‚ĞµÑ€Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼

```bash
# ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¸Ğ½Ñ‚ĞµÑ€Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ñ€ĞµĞ¶Ğ¸Ğ¼
go tool pprof cpu.prof
```

**ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:**

#### `top` â€” Ñ‚Ğ¾Ğ¿ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹ Ğ¿Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸

```
(pprof) top
Showing nodes accounting for 4.5s, 90% of 5s total
      flat  flat%   sum%        cum   cum%
     2.0s 40.00% 40.00%      2.5s 50.00%  main.processData
     1.5s 30.00% 70.00%      1.5s 30.00%  runtime.mallocgc
     0.5s 10.00% 80.00%      3.0s 60.00%  main.handleRequest
     0.3s  6.00% 86.00%      0.3s  6.00%  encoding/json.Marshal
     0.2s  4.00% 90.00%      0.2s  4.00%  runtime.memmove
```

**Ğ§Ñ‚Ğ¾ Ğ¾Ğ·Ğ½Ğ°Ñ‡Ğ°ÑÑ‚ ĞºĞ¾Ğ»Ğ¾Ğ½ĞºĞ¸:**
- **flat** â€” Ğ²Ñ€ĞµĞ¼Ñ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² ÑÑ‚Ğ¾Ğ¹ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ (Ğ±ĞµĞ· Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²)
- **cum** (cumulative) â€” Ğ¾Ğ±Ñ‰ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ (Ğ²ĞºĞ»ÑÑ‡Ğ°Ñ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                FLAT vs CUM (CUMULATIVE)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚   func A() {           â”‚   flat(A) = 1s (Ğ²Ñ€ĞµĞ¼Ñ Ğ² ÑĞ°Ğ¼Ğ¾Ğ¹ A)   â”‚
â”‚       // 1s Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹     â”‚   cum(A)  = 4s (A + B + C)         â”‚
â”‚       B()              â”‚                                     â”‚
â”‚   }                    â”‚   flat(B) = 2s                      â”‚
â”‚                        â”‚   cum(B)  = 3s (B + C)              â”‚
â”‚   func B() {           â”‚                                     â”‚
â”‚       // 2s Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹     â”‚   flat(C) = 1s                      â”‚
â”‚       C()              â”‚   cum(C)  = 1s                      â”‚
â”‚   }                    â”‚                                     â”‚
â”‚                        â”‚                                     â”‚
â”‚   func C() {           â”‚   âš ï¸ Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ flat = ĞºĞ¾Ğ´ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸     â”‚
â”‚       // 1s Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹     â”‚   âš ï¸ Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ cum = Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¸Ğ»Ğ¸      â”‚
â”‚   }                    â”‚      ĞµÑ‘ Ğ´Ğ¾Ñ‡ĞµÑ€Ğ½Ğ¸Ğµ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹             â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### `top -cum` â€” Ñ‚Ğ¾Ğ¿ Ğ¿Ğ¾ cumulative time

```
(pprof) top -cum
Showing nodes accounting for 4.5s, 90% of 5s total
      flat  flat%   sum%        cum   cum%
     0.1s  2.00%  2.00%      5.0s   100%  main.main
     0.5s 10.00% 12.00%      3.0s 60.00%  main.handleRequest
     2.0s 40.00% 52.00%      2.5s 50.00%  main.processData
```

#### `list` â€” Ğ¸ÑÑ…Ğ¾Ğ´Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´ Ñ Ğ°Ğ½Ğ½Ğ¾Ñ‚Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸

```
(pprof) list processData
Total: 5s
ROUTINE ======================== main.processData
     2.0s      2.5s (flat, cum) 50.00% of Total
         .          .     15:func processData(data []byte) Result {
         .          .     16:    var result Result
     0.5s      0.5s     17:    for _, b := range data {        // â† 0.5s Ğ·Ğ´ĞµÑÑŒ
     1.0s      1.0s     18:        result.Sum += int(b)        // â† 1.0s Ğ·Ğ´ĞµÑÑŒ
     0.5s      0.5s     19:        result.Count++              // â† 0.5s Ğ·Ğ´ĞµÑÑŒ
         .          .     20:    }
         .      0.5s     21:    result.Normalize()             // â† 0.5s Ğ² Normalize
         .          .     22:    return result
         .          .     23:}
```

#### `web` â€” Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ

```bash
(pprof) web
# ĞÑ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ³Ñ€Ğ°Ñ„ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ (Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ graphviz)
```

### 1.5 Flame Graphs

Flame Graph â€” ÑÑ‚Ğ¾ ÑĞ°Ğ¼Ñ‹Ğ¹ ÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¾ÑĞ¾Ğ± Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ CPU Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ.

```bash
# Ğ’ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ²ĞµĞ±-Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ñ flame graph
go tool pprof -http=:8080 cpu.prof
```

**ĞšĞ°Ğº Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Flame Graph:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      FLAME GRAPH                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    main.main                         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚     main.handleRequest    â”‚â”‚    main.loadConfig     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚   â”‚main.process â”‚â”‚ json.Marshalâ”‚                            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”                                                  â”‚
â”‚   â”‚computeâ”‚                                                  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”˜                                                  â”‚
â”‚                                                              â”‚
â”‚   Ğ¨Ğ¸Ñ€Ğ¸Ğ½Ğ° = Ğ²Ñ€ĞµĞ¼Ñ CPU                                        â”‚
â”‚   Ğ’Ñ‹ÑĞ¾Ñ‚Ğ° = Ğ³Ğ»ÑƒĞ±Ğ¸Ğ½Ğ° ÑÑ‚ĞµĞºĞ°                                    â”‚
â”‚   â†‘ ĞšĞ»Ğ¸ĞºĞ½Ğ¸ Ğ½Ğ° Ğ±Ğ»Ğ¾Ğº = zoom in                                â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ˜Ğ½Ñ‚ĞµÑ€Ğ¿Ñ€ĞµÑ‚Ğ°Ñ†Ğ¸Ñ:**
- **Ğ¨Ğ¸Ñ€Ğ¾ĞºĞ¸Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸** â€” Ğ¼Ğ½Ğ¾Ğ³Ğ¾ CPU Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸, Ğ¿Ğ¾Ñ‚ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ bottlenecks
- **Ğ“Ğ»ÑƒĞ±Ğ¾ĞºĞ¸Ğµ ÑÑ‚ĞµĞºĞ¸** â€” Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ² Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹ (Ğ²Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ¾, Ñ€ĞµĞºÑƒÑ€ÑĞ¸Ñ)
- **ĞŸĞ»Ğ¾ÑĞºĞ¸Ğµ ÑˆĞ¸Ñ€Ğ¾ĞºĞ¸Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸** â€” Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ñ Ñ‚ÑĞ¶Ñ‘Ğ»Ñ‹Ğ¼Ğ¸ Ğ²Ñ‹Ñ‡Ğ¸ÑĞ»ĞµĞ½Ğ¸ÑĞ¼Ğ¸ Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸

### 1.6 Ğ¢Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ñ‹Ğµ CPU bottlenecks

#### 1. Ğ˜Ğ·Ğ±Ñ‹Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ğ°Ğ»Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¸ (GC pressure)

```go
// âŒ ĞŸĞ»Ğ¾Ñ…Ğ¾: Ğ°Ğ»Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ Ğ² ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ¸Ñ‚ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
func processBad(items []string) []string {
    var result []string  // len=0, cap=0
    for _, item := range items {
        result = append(result, transform(item))  // Grow â†’ allocate
    }
    return result
}

// âœ… Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾: preallocation
func processGood(items []string) []string {
    result := make([]string, 0, len(items))  // Preallocate capacity
    for _, item := range items {
        result = append(result, transform(item))  // No reallocation
    }
    return result
}
```

> ğŸ’¡ **Ğ¡Ğ²ÑĞ·ÑŒ Ñ GC**: ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½ĞµĞµ Ğ¾Ğ± Ğ°Ğ»Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸ÑÑ… Ğ¸ escape analysis â€” [Ñ€Ğ°Ğ·Ğ´ĞµĞ» 2.3](./03_gc.md).

#### 2. ĞšĞ¾Ğ½ĞºĞ°Ñ‚ĞµĞ½Ğ°Ñ†Ğ¸Ñ ÑÑ‚Ñ€Ğ¾Ğº

```go
// âŒ ĞŸĞ»Ğ¾Ñ…Ğ¾: O(nÂ²) Ğ¿Ğ¾ Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸
func joinBad(items []string) string {
    result := ""
    for _, s := range items {
        result += s  // ĞšĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ€Ğ°Ğ· Ğ½Ğ¾Ğ²Ğ°Ñ Ğ°Ğ»Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ!
    }
    return result
}

// âœ… Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾: O(n) Ñ strings.Builder
func joinGood(items []string) string {
    var b strings.Builder
    b.Grow(estimatedSize)  // ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾: preallocate
    for _, s := range items {
        b.WriteString(s)
    }
    return b.String()
}
```

**Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸:**

```
BenchmarkJoinBad-8      1000000    15234 ns/op    58320 B/op   999 allocs/op
BenchmarkJoinGood-8    10000000      234 ns/op      512 B/op     1 allocs/op
```

#### 3. JSON marshaling/unmarshaling

```go
// âŒ ĞŸĞ»Ğ¾Ñ…Ğ¾: encoding/json Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ reflection
import "encoding/json"

func handleRequest(w http.ResponseWriter, r *http.Request) {
    var req Request
    json.NewDecoder(r.Body).Decode(&req)  // Reflection + allocations

    resp := process(req)
    json.NewEncoder(w).Encode(resp)  // Reflection + allocations
}
```

**ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ñ‹ (Ğ¿Ğ¾ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚Ğ¸):**

| Ğ‘Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ° | Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ vs encoding/json | ĞÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸ |
|------------|---------------------------|-------------|
| `encoding/json` | 1x (baseline) | Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ°Ñ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ° |
| `json-iterator` | ~3-5x | Drop-in replacement |
| `easyjson` | ~5-7x | Code generation |
| `sonic` | ~10x | SIMD, code gen |
| `goccy/go-json` | ~3-5x | Drop-in, zero-alloc |

```go
// âœ… Ğ¡ easyjson (code generation)
//go:generate easyjson -all types.go

func handleRequestFast(w http.ResponseWriter, r *http.Request) {
    var req Request
    easyjson.UnmarshalFromReader(r.Body, &req)

    resp := process(req)
    easyjson.MarshalToWriter(resp, w)
}
```

#### 4. Reflection

```go
// âŒ ĞŸĞ»Ğ¾Ñ…Ğ¾: reflection Ğ² hot path
func processBad(v interface{}) {
    rv := reflect.ValueOf(v)
    for i := 0; i < rv.NumField(); i++ {
        field := rv.Field(i)
        // ...
    }
}

// âœ… Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾: generics (Go 1.18+)
func processGood[T any](v T) {
    // Type-safe, no reflection
}

// âœ… Ğ˜Ğ»Ğ¸: type switch Ğ´Ğ»Ñ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ñ… Ñ‚Ğ¸Ğ¿Ğ¾Ğ²
func processSwitch(v interface{}) {
    switch x := v.(type) {
    case *User:
        processUser(x)
    case *Order:
        processOrder(x)
    }
}
```

#### 5. Mutex contention

```go
// âŒ ĞŸĞ»Ğ¾Ñ…Ğ¾: Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ mutex
var (
    mu    sync.Mutex
    cache = make(map[string]Value)
)

func Get(key string) Value {
    mu.Lock()
    defer mu.Unlock()
    return cache[key]  // Read-only, Ğ½Ğ¾ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ Ğ²ÑĞµÑ…
}

// âœ… Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾: RWMutex Ğ´Ğ»Ñ read-heavy workloads
var (
    mu    sync.RWMutex
    cache = make(map[string]Value)
)

func Get(key string) Value {
    mu.RLock()
    defer mu.RUnlock()
    return cache[key]  // ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ
}

// âœ… Ğ•Ñ‰Ñ‘ Ğ»ÑƒÑ‡ÑˆĞµ: sharded cache
type ShardedCache struct {
    shards [256]struct {
        sync.RWMutex
        data map[string]Value
    }
}

func (c *ShardedCache) getShard(key string) *shard {
    h := fnv.New32a()
    h.Write([]byte(key))
    return &c.shards[h.Sum32()%256]
}
```

> ğŸ’¡ **Ğ¡Ğ²ÑĞ·ÑŒ Ñ sync**: ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½ĞµĞµ Ğ¾ mutex Ğ¸ contention â€” [Ñ€Ğ°Ğ·Ğ´ĞµĞ» 2.4](./04_sync_primitives.md).

#### 6. Ğ ĞµĞ³ÑƒĞ»ÑÑ€Ğ½Ñ‹Ğµ Ğ²Ñ‹Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ

```go
// âŒ ĞŸĞ»Ğ¾Ñ…Ğ¾: ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ†Ğ¸Ñ regex Ğ² ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğµ
func validateBad(email string) bool {
    re := regexp.MustCompile(`^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$`)
    return re.MatchString(email)
}

// âœ… Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾: ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ†Ğ¸Ñ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ·
var emailRegex = regexp.MustCompile(`^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$`)

func validateGood(email string) bool {
    return emailRegex.MatchString(email)
}

// âœ… Ğ•Ñ‰Ñ‘ Ğ»ÑƒÑ‡ÑˆĞµ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ñ… ÑĞ»ÑƒÑ‡Ğ°ĞµĞ²: strings functions
func validateFast(email string) bool {
    at := strings.Index(email, "@")
    if at == -1 || at == 0 {
        return false
    }
    dot := strings.LastIndex(email[at:], ".")
    return dot > 1 && dot < len(email[at:])-2
}
```

---

## 2. go tool trace: Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·

`go tool trace` â€” ÑÑ‚Ğ¾ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ Ğ´Ğ»Ñ Ğ´ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹ Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸. Ğ’ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ¾Ñ‚ pprof (ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ°Ğ³Ñ€ĞµĞ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½ÑƒÑ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºÑƒ), trace Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ **Ñ‡Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ğ»Ğ¾ Ğ² ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸**.

> ğŸ’¡ **Ğ¡Ğ²ÑĞ·ÑŒ Ñ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¾Ğ¼ 2.2**: Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ trace Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ñ‰Ğ¸ĞºĞ° â€” Ğ² [Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğµ 2.2 (Runtime)](./02_runtime_scheduler.md). Ğ—Ğ´ĞµÑÑŒ Ñ„Ğ¾ĞºÑƒÑĞ¸Ñ€ÑƒĞµĞ¼ÑÑ Ğ½Ğ° Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¼ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¸ Ğ´Ğ»Ñ Ğ´Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼.

### 2.1 ĞšĞ¾Ğ³Ğ´Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ trace vs pprof

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              PPROF vs TRACE: ĞšĞĞ“Ğ”Ğ Ğ§Ğ¢Ğ Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ¬         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚   Ğ’ĞĞŸĞ ĞĞ¡                          â”‚ Ğ˜ĞĞ¡Ğ¢Ğ Ğ£ĞœĞ•ĞĞ¢              â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚   "Ğ“Ğ´Ğµ Ñ‚Ñ€Ğ°Ñ‚Ğ¸Ñ‚ÑÑ CPU Ğ²Ñ€ĞµĞ¼Ñ?"       â”‚ pprof CPU               â”‚
â”‚   "Ğ“Ğ´Ğµ Ğ²Ñ‹Ğ´ĞµĞ»ÑĞµÑ‚ÑÑ Ğ¿Ğ°Ğ¼ÑÑ‚ÑŒ?"        â”‚ pprof heap/allocs       â”‚
â”‚   "ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒÑÑ‚ÑÑ?"  â”‚ go tool trace âœ“         â”‚
â”‚   "ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ ĞµÑÑ‚ÑŒ latency spikes?"   â”‚ go tool trace âœ“         â”‚
â”‚   "Ğ§Ñ‚Ğ¾ Ğ´ĞµĞ»Ğ°Ğ» Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ñ‰Ğ¸Ğº?"        â”‚ go tool trace âœ“         â”‚
â”‚   "Ğ“Ğ´Ğµ mutex contention?"         â”‚ pprof mutex + trace     â”‚
â”‚   "ĞšĞ¾Ğ³Ğ´Ğ° Ğ±Ñ‹Ğ»Ğ¸ GC Ğ¿Ğ°ÑƒĞ·Ñ‹?"          â”‚ go tool trace âœ“         â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ĞšĞ»ÑÑ‡ĞµĞ²Ğ¾Ğµ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ¸Ğµ:**

| ĞÑĞ¿ĞµĞºÑ‚ | pprof | go tool trace |
|--------|-------|---------------|
| **Ğ¢Ğ¸Ğ¿ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…** | ĞĞ³Ñ€ĞµĞ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ ÑÑ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° | Timeline ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ |
| **Ğ’Ğ¾Ğ¿Ñ€Ğ¾Ñ** | "Ğ¡ĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ² Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ X?" | "Ğ§Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ğ»Ğ¾ Ğ² Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ T?" |
| **Overhead** | ~5-10% | ~10-25% |
| **Ğ Ğ°Ğ·Ğ¼ĞµÑ€ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…** | ĞšĞ¸Ğ»Ğ¾Ğ±Ğ°Ğ¹Ñ‚Ñ‹ | ĞœĞµĞ³Ğ°Ğ±Ğ°Ğ¹Ñ‚Ñ‹ (10MB/sec) |
| **Ğ’Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ** | Flame graph, text | Timeline Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ |

**Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ .NET:**

| Go | .NET |
|----|------|
| `go tool trace` | Concurrency Visualizer (VS Enterprise) |
| Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ğ¹ | $5000+/Ğ³Ğ¾Ğ´ (Enterprise Ğ»Ğ¸Ñ†ĞµĞ½Ğ·Ğ¸Ñ) |
| CLI + Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€ | Visual Studio only |

### 2.2 Ğ¡Ğ±Ğ¾Ñ€ Ğ¸ Ğ²Ğ¸Ğ·ÑƒĞ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ trace

#### Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ± 1: Ğ§ĞµÑ€ĞµĞ· Ñ‚ĞµÑÑ‚Ñ‹

```bash
# Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ñ‚ĞµÑÑ‚Ñ‹ Ğ¸ ÑĞ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ trace
go test -trace=trace.out ./...

# Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ benchmark Ñ trace
go test -bench=BenchmarkProcess -trace=trace.out

# ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ trace Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ
go tool trace trace.out
```

#### Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ± 2: ĞŸÑ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ½Ğ¾

```go
package main

import (
    "os"
    "runtime/trace"
)

func main() {
    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ñ„Ğ°Ğ¹Ğ» Ğ´Ğ»Ñ trace
    f, err := os.Create("trace.out")
    if err != nil {
        panic(err)
    }
    defer f.Close()

    // ĞĞ°Ñ‡Ğ¸Ğ½Ğ°ĞµĞ¼ Ñ‚Ñ€Ğ°ÑÑĞ¸Ñ€Ğ¾Ğ²ĞºÑƒ
    if err := trace.Start(f); err != nil {
        panic(err)
    }
    defer trace.Stop()

    // Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼ ĞºĞ¾Ğ´
    runApplication()
}
```

#### Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ± 3: Ğ§ĞµÑ€ĞµĞ· HTTP endpoint

```bash
# Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ 5-ÑĞµĞºÑƒĞ½Ğ´Ğ½Ñ‹Ğ¹ trace
curl -o trace.out "http://localhost:6060/debug/pprof/trace?seconds=5"

# ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ
go tool trace trace.out
```

#### Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ± 4: User-defined tasks Ğ¸ regions (Go 1.11+)

```go
import "runtime/trace"

func processOrder(ctx context.Context, order Order) error {
    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ task Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ ÑĞ²ÑĞ·Ğ°Ğ½Ğ½Ñ‹Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹
    ctx, task := trace.NewTask(ctx, "processOrder")
    defer task.End()

    // Region Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ Ñ„Ğ°Ğ·Ñ‹
    trace.WithRegion(ctx, "validation", func() {
        validateOrder(order)
    })

    trace.WithRegion(ctx, "payment", func() {
        processPayment(order)
    })

    trace.WithRegion(ctx, "notification", func() {
        sendNotification(order)
    })

    return nil
}
```

### 2.3 ĞĞ½Ğ°Ğ»Ğ¸Ğ· Goroutine Analysis

ĞŸĞ¾ÑĞ»Ğµ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ñ `go tool trace trace.out` Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ, ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ÑĞµĞºÑ†Ğ¸Ğ¸:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  GO TOOL TRACE: ĞĞ¡ĞĞĞ’ĞĞ«Ğ• VIEWS              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  1. View trace                                               â”‚
â”‚     â””â”€â”€ Timeline Ğ²ÑĞµÑ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹ (Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹, GC, syscalls)      â”‚
â”‚                                                              â”‚
â”‚  2. Goroutine analysis                                       â”‚
â”‚     â””â”€â”€ Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° Ğ¿Ğ¾ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ğ°Ğ¼:                            â”‚
â”‚         â€¢ Execution time (Ğ²Ñ€ĞµĞ¼Ñ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ)                 â”‚
â”‚         â€¢ Network wait (Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞµÑ‚Ğ¸)                      â”‚
â”‚         â€¢ Sync block (Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ½Ğ° mutex/channel)          â”‚
â”‚         â€¢ Syscall (ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ñ‹)                        â”‚
â”‚         â€¢ Scheduler wait (Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ñ‰Ğ¸ĞºĞ°)            â”‚
â”‚                                                              â”‚
â”‚  3. Network blocking profile                                 â”‚
â”‚     â””â”€â”€ Ğ“Ğ´Ğµ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹ Ğ¶Ğ´ÑƒÑ‚ ÑĞµÑ‚ÑŒ                              â”‚
â”‚                                                              â”‚
â”‚  4. Synchronization blocking profile                         â”‚
â”‚     â””â”€â”€ Ğ“Ğ´Ğµ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹ Ğ¶Ğ´ÑƒÑ‚ mutex/channel                     â”‚
â”‚                                                              â”‚
â”‚  5. Syscall blocking profile                                 â”‚
â”‚     â””â”€â”€ Ğ“Ğ´Ğµ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹ Ğ¶Ğ´ÑƒÑ‚ syscalls (file I/O, etc.)         â”‚
â”‚                                                              â”‚
â”‚  6. User-defined tasks                                       â”‚
â”‚     â””â”€â”€ Ğ’Ğ°ÑˆĞ¸ trace.NewTask Ğ¸ trace.WithRegion               â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Goroutine analysis â€” ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸:**

```
Goroutine analysis:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Goroutine Name             Count   Total Time   Execution   Network   Sync Block
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
main.handleRequest           100     10.5s        2.1s       5.2s      3.2s
main.processData              50      5.2s        4.8s       0.1s      0.3s
runtime.gcBgMarkWorker         4      1.2s        1.2s       0s        0s
```

**Ğ˜Ğ½Ñ‚ĞµÑ€Ğ¿Ñ€ĞµÑ‚Ğ°Ñ†Ğ¸Ñ:**
- **High Network wait** â†’ ĞœĞµĞ´Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ²Ğ½ĞµÑˆĞ½Ğ¸Ğµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹, Ğ‘Ğ”
- **High Sync block** â†’ Contention Ğ½Ğ° mutex Ğ¸Ğ»Ğ¸ Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ½Ñ‹Ğµ ĞºĞ°Ğ½Ğ°Ğ»Ñ‹
- **High Syscall** â†’ ĞœĞ½Ğ¾Ğ³Ğ¾ disk I/O
- **High Scheduler wait** â†’ Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½, Ğ½Ğµ Ñ…Ğ²Ğ°Ñ‚Ğ°ĞµÑ‚ P

### 2.4 Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° latency spikes

Latency spikes â€” ÑÑ‚Ğ¾ ĞºĞ¾Ğ³Ğ´Ğ° P99 latency Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ²Ñ‹ÑˆĞµ P50. Ğ¢Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹:

#### ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° 1: GC Ğ¿Ğ°ÑƒĞ·Ñ‹ (STW)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     GC PAUSE Ğ’ TRACE                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  Timeline:                                                   â”‚
â”‚                                                              â”‚
â”‚  Goroutine 1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                  â”‚
â”‚  Goroutine 2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                â”‚
â”‚  Goroutine 3: â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ              â”‚
â”‚                     â–²                                        â”‚
â”‚                     â”‚                                        â”‚
â”‚               GC STW (stop-the-world)                       â”‚
â”‚               Ğ’ÑĞµ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹                      â”‚
â”‚                                                              â”‚
â”‚  âš ï¸ STW > 1ms = Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° Ğ´Ğ»Ñ low-latency ÑĞ¸ÑÑ‚ĞµĞ¼            â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°:**
1. ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ trace, Ğ½Ğ°Ğ¹Ñ‚Ğ¸ "GC" ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ
2. ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ½Ğ° Ğ´Ğ»Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ STW Ñ„Ğ°Ğ·
3. Ğ•ÑĞ»Ğ¸ STW > 1ms, Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ°Ğ»Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¸

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
- Ğ£Ğ¼ĞµĞ½ÑŒÑˆĞ¸Ñ‚ÑŒ Ğ°Ğ»Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¸ (escape analysis, sync.Pool)
- Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ñ‚ÑŒ GOGC (Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸, Ñ€ĞµĞ¶Ğµ GC)
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ GOMEMLIMIT

> ğŸ’¡ **ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½ĞµĞµ**: [Ğ Ğ°Ğ·Ğ´ĞµĞ» 2.3 (GC)](./03_gc.md)

#### ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° 2: Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ½Ğ° mutex

```go
// Ğ¡Ğ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼ Ğ² trace: Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ "Sync block" Ğ´Ğ»Ñ Ğ¼Ğ½Ğ¾Ğ³Ğ¸Ñ… Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½

// ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´
var globalMu sync.Mutex
var cache = make(map[string]Value)

func handleRequest(key string) Value {
    globalMu.Lock()  // â† Ğ’ÑĞµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ ÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·ÑƒÑÑ‚ÑÑ Ğ·Ğ´ĞµÑÑŒ
    defer globalMu.Unlock()

    if v, ok := cache[key]; ok {
        return v
    }
    v := computeExpensive(key)
    cache[key] = v
    return v
}
```

**ĞšĞ°Ğº Ğ²Ñ‹Ğ³Ğ»ÑĞ´Ğ¸Ñ‚ Ğ² trace:**
```
Goroutine 1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  (executing)
Goroutine 2: â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  (blocked on mutex)
Goroutine 3: â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  (blocked on mutex)
```

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
- RWMutex Ğ´Ğ»Ñ read-heavy workloads
- Sharding (Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ locks)
- Lock-free ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹ (sync/atomic)

> ğŸ’¡ **ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½ĞµĞµ**: [Ğ Ğ°Ğ·Ğ´ĞµĞ» 2.4 (Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ)](./04_sync_primitives.md)

#### ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° 3: ĞœĞµĞ´Ğ»ĞµĞ½Ğ½Ñ‹Ğµ syscalls (I/O)

```go
// Ğ¡Ğ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼ Ğ² trace: Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ "Syscall" time

func handleRequest(w http.ResponseWriter, r *http.Request) {
    // Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ¾Ğµ Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ° â€” Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñƒ
    data, _ := os.ReadFile("/var/log/large.log")  // â† Syscall blocking

    // Ğ¡Ğ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğº Ğ²Ğ½ĞµÑˆĞ½ĞµĞ¼Ñƒ ÑĞµÑ€Ğ²Ğ¸ÑÑƒ
    resp, _ := http.Get("http://slow-service/api")  // â† Network blocking
    defer resp.Body.Close()

    // ...
}
```

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**
- ĞÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ñ‡ĞµÑ€ĞµĞ· Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹
- ĞšÑÑˆĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ğ¾Ğ²
- Connection pooling

#### ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ğ° 4: Scheduler latency

```
Ğ¡Ğ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼: Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹ Ğ´Ğ¾Ğ»Ğ³Ğ¾ Ğ¶Ğ´ÑƒÑ‚ Ğ² "Runnable" ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ğ¸
(Ğ¶Ğ´ÑƒÑ‚ Ğ¿Ğ¾ĞºĞ° Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ñ‰Ğ¸Ğº Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ Ğ¸Ñ… Ğ½Ğ° P)
```

**Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ°:**
```bash
GODEBUG=schedtrace=1000 ./myapp
```

**ĞŸÑ€Ğ¸Ñ‡Ğ¸Ğ½Ñ‹:**
- Ğ¡Ğ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½ (> 10K Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ…)
- GOMAXPROCS ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ½Ğ¸Ğ·ĞºĞ¸Ğ¹
- Ğ“Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹ Ğ½Ğµ yielding (Ğ½ĞµÑ‚ I/O, Ğ½ĞµÑ‚ runtime.Gosched())

---

## 3. ĞšĞ¾Ğ¼Ğ¿Ğ»ĞµĞºÑĞ½Ñ‹Ğ¹ workflow Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

Ğ­Ñ‚Ğ¾Ñ‚ Ñ€Ğ°Ğ·Ğ´ĞµĞ» Ğ¾Ğ±ÑŠĞµĞ´Ğ¸Ğ½ÑĞµÑ‚ Ğ²ÑĞµ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹ Ğ² ĞµĞ´Ğ¸Ğ½ÑƒÑ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸.

### 3.1 ĞœĞµÑ‚Ğ¾Ğ´Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ: Measure â†’ Identify â†’ Optimize â†’ Verify

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 WORKFLOW ĞŸĞ ĞĞ¤Ğ˜Ğ›Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ¯                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚  1. MEASURE  â”‚ â† Ğ’Ğ¾ÑĞ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñƒ, ÑĞ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚  2. IDENTIFY â”‚ â† ĞŸÑ€Ğ¾Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ, Ğ½Ğ°Ğ¹Ñ‚Ğ¸ bottleneck  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚  3. OPTIMIZE â”‚ â† Ğ˜Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ´                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                               â”‚
â”‚  â”‚  4. VERIFY   â”‚ â† ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚ÑŒ ÑƒĞ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ğµ (benchstat)           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                               â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Ğ£Ğ»ÑƒÑ‡ÑˆĞµĞ½Ğ¸Ğµ Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾?  â”€â”€Noâ”€â”€â–º  Ğ’ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğº ÑˆĞ°Ğ³Ñƒ 1      â”‚   â”‚
â”‚  â”‚         â”‚                                                 â”‚   â”‚
â”‚  â”‚        Yes                                                â”‚   â”‚
â”‚  â”‚         â–¼                                                 â”‚   â”‚
â”‚  â”‚      Ğ“ĞĞ¢ĞĞ’Ğ                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Ğ¨Ğ°Ğ³ 1: Measure (Ğ˜Ğ·Ğ¼ĞµÑ€ĞµĞ½Ğ¸Ğµ)

```bash
# 1. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ²Ğ¾ÑĞ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğ¹ benchmark
go test -bench=BenchmarkHandler -count=10 > before.txt

# 2. Ğ¡Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ CPU
go test -bench=BenchmarkHandler -cpuprofile=cpu.prof

# 3. Ğ˜Ğ»Ğ¸ Ğ´Ğ»Ñ running ÑĞµÑ€Ğ²Ğ¸ÑĞ°
curl -o cpu.prof "http://localhost:6060/debug/pprof/profile?seconds=30"
```

**Ğ’Ğ°Ğ¶Ğ½Ğ¾:**
- Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ½Ğ° **Ñ€ĞµĞ°Ğ»Ğ¸ÑÑ‚Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…**
- Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ **production-like Ğ½Ğ°Ğ³Ñ€ÑƒĞ·ĞºÑƒ**
- Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°Ñ‚ÑŒ **Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ samples** (Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 30 ÑĞµĞºÑƒĞ½Ğ´ Ğ´Ğ»Ñ production)

#### Ğ¨Ğ°Ğ³ 2: Identify (Ğ˜Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ)

```bash
# ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ
go tool pprof -http=:8080 cpu.prof

# Ğ’ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ:
# 1. ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Flame Graph â€” Ğ½Ğ°Ğ¹Ñ‚Ğ¸ ÑˆĞ¸Ñ€Ğ¾ĞºĞ¸Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸
# 2. top -cum â€” Ğ½Ğ°Ğ¹Ñ‚Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ñ Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ğ¼ cumulative time
# 3. list <function> â€” Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ ĞºĞ¾Ğ´ Ñ Ğ°Ğ½Ğ½Ğ¾Ñ‚Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸
```

**Ğ¢Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ñ‹Ğµ Ğ½Ğ°Ñ…Ğ¾Ğ´ĞºĞ¸:**
```
ĞĞ°Ñ…Ğ¾Ğ´ĞºĞ°                          â”‚ Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¸Ñ‡Ğ¸Ğ½Ğ°
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
runtime.mallocgc Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ >20%   â”‚ ĞœĞ½Ğ¾Ğ³Ğ¾ Ğ°Ğ»Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¹, GC pressure
encoding/json.* Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ğ¼Ğ½Ğ¾Ğ³Ğ¾   â”‚ ĞœĞµĞ´Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ JSON
runtime.lock/unlock Ğ¼Ğ½Ğ¾Ğ³Ğ¾        â”‚ Mutex contention
syscall.* Ğ¼Ğ½Ğ¾Ğ³Ğ¾                  â”‚ I/O bottleneck
runtime.memmove Ğ¼Ğ½Ğ¾Ğ³Ğ¾            â”‚ ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
```

#### Ğ¨Ğ°Ğ³ 3: Optimize (ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ)

ĞŸĞ¾ÑĞ»Ğµ Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ bottleneck â€” Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ´:

```go
// ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: Ğ½Ğ°ÑˆĞ»Ğ¸ Ñ‡Ñ‚Ğ¾ strings concat Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹
// Ğ”Ğ¾:
func process(items []string) string {
    result := ""
    for _, s := range items {
        result += s  // â† Bottleneck Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğµ
    }
    return result
}

// ĞŸĞ¾ÑĞ»Ğµ:
func process(items []string) string {
    var b strings.Builder
    b.Grow(estimatedSize)
    for _, s := range items {
        b.WriteString(s)
    }
    return b.String()
}
```

#### Ğ¨Ğ°Ğ³ 4: Verify (Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ)

```bash
# Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ñ‚Ğ¾Ñ‚ Ğ¶Ğµ benchmark Ğ¿Ğ¾ÑĞ»Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹
go test -bench=BenchmarkHandler -count=10 > after.txt

# Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚Ñ‹ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ benchstat
benchstat before.txt after.txt
```

**ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ° benchstat:**

```
name              old time/op    new time/op    delta
Handler-8           1.25ms Â± 2%    0.42ms Â± 3%   -66.4%  (p=0.000 n=10+10)

name              old alloc/op   new alloc/op   delta
Handler-8           48.2kB Â± 0%    12.1kB Â± 0%   -74.9%  (p=0.000 n=10+10)

name              old allocs/op  new allocs/op  delta
Handler-8              125 Â± 0%        32 Â± 0%   -74.4%  (p=0.000 n=10+10)
```

> ğŸ’¡ **ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½ĞµĞµ Ğ¾ benchstat**: [Ğ Ğ°Ğ·Ğ´ĞµĞ» 2.6 (Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ)](./06_testing_benchmarking.md)

### 3.2 Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ° Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ĞœĞĞ¢Ğ Ğ˜Ğ¦Ğ Ğ’Ğ«Ğ‘ĞĞ Ğ Ğ˜ĞĞ¡Ğ¢Ğ Ğ£ĞœĞ•ĞĞ¢Ğ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Ğ¡Ğ˜ĞœĞŸĞ¢ĞĞœ                      â”‚ ĞŸĞ•Ğ Ğ’Ğ«Ğ™ Ğ˜ĞĞ¡Ğ¢Ğ Ğ£ĞœĞ•ĞĞ¢              â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚   Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ CPU usage            â”‚ pprof CPU + flame graph        â”‚
â”‚   Ğ’Ñ‹ÑĞ¾ĞºĞ¾Ğµ Ğ¿Ğ¾Ñ‚Ñ€ĞµĞ±Ğ»ĞµĞ½Ğ¸Ğµ RAM      â”‚ pprof heap                     â”‚
â”‚   Ğ§Ğ°ÑÑ‚Ñ‹Ğµ GC Ğ¿Ğ°ÑƒĞ·Ñ‹              â”‚ GODEBUG=gctrace + pprof allocs â”‚
â”‚   Latency spikes (P99 >> P50)  â”‚ go tool trace                  â”‚
â”‚   Data races                   â”‚ go test -race                  â”‚
â”‚   Goroutine leaks              â”‚ pprof goroutine                â”‚
â”‚   ĞœĞµĞ´Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹ throughput         â”‚ benchmarks + pprof CPU         â”‚
â”‚   Mutex contention             â”‚ pprof mutex + trace            â”‚
â”‚   I/O bottleneck               â”‚ go tool trace (syscall)        â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ‘Ğ»Ğ¾Ğº-ÑÑ…ĞµĞ¼Ğ° Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ°:**

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ĞšĞ°ĞºĞ°Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°? â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â–¼                   â–¼                   â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚   CPU %   â”‚       â”‚  Memory   â”‚       â”‚  Latency  â”‚
   â”‚   Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ â”‚       â”‚  Ñ€Ğ°ÑÑ‚Ñ‘Ñ‚   â”‚       â”‚  ÑĞ¿Ğ°Ğ¹ĞºĞ¸   â”‚
   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚                   â”‚                   â”‚
         â–¼                   â–¼                   â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚pprof CPU  â”‚       â”‚pprof heap â”‚       â”‚ go tool   â”‚
   â”‚flame graphâ”‚       â”‚+ allocs   â”‚       â”‚   trace   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ CI/CD

ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ€ĞµĞ³Ñ€ĞµÑÑĞ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸.

#### GitHub Actions: Benchmark Ğ½Ğ° ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ PR

```yaml
# .github/workflows/benchmark.yml
name: Benchmark

on:
  pull_request:
    branches: [main]

jobs:
  benchmark:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Run benchmarks
        run: |
          go test -bench=. -count=10 -benchmem ./... > new.txt

      - name: Download baseline
        uses: actions/download-artifact@v4
        with:
          name: benchmark-baseline
        continue-on-error: true  # ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº

      - name: Compare with baseline
        run: |
          if [ -f old.txt ]; then
            go install golang.org/x/perf/cmd/benchstat@latest
            benchstat old.txt new.txt | tee comparison.txt

            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ½Ğ° Ñ€ĞµĞ³Ñ€ĞµÑÑĞ¸Ğ¸ > 10%
            if grep -E '\+[0-9]{2,}\.[0-9]+%' comparison.txt; then
              echo "::warning::Performance regression detected!"
            fi
          fi

      - name: Save as baseline (main only)
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-baseline
          path: new.txt
```

#### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ Ñ Ñ€ĞµĞ³Ñ€ĞµÑÑĞ¸ĞµĞ¹:

```
                                   PR #123
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  benchstat old.txt new.txt                                       â”‚
â”‚                                                                  â”‚
â”‚  name              old time/op    new time/op    delta          â”‚
â”‚  Handler-8           1.25ms Â± 2%    1.89ms Â± 3%   +51.2%  âš ï¸     â”‚
â”‚                                                                  â”‚
â”‚  ::warning:: Performance regression detected!                   â”‚
â”‚  PR blocked until regression is fixed or approved               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Ğ¡Ğ±Ğ¾Ñ€ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ĞµĞ¹ Ğ² production (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)

```yaml
# ĞŸĞµÑ€Ğ¸Ğ¾Ğ´Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ÑĞ±Ğ¾Ñ€ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ĞµĞ¹
- name: Collect production profile
  run: |
    curl -o cpu.prof "http://prod-service:6060/debug/pprof/profile?seconds=30"
    # ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ² S3 / GCS Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°
    aws s3 cp cpu.prof s3://profiles/$(date +%Y-%m-%d)/cpu.prof
```

---

## 4. ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ production-ĞºĞ¾Ğ´Ğ°

ĞŸĞ¾ÑĞ»Ğµ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ â€” Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸.

### 4.1 Hot paths Ğ¸ Ğ·Ğ°ĞºĞ¾Ğ½ ĞĞ¼Ğ´Ğ°Ğ»Ğ°

**Ğ—Ğ°ĞºĞ¾Ğ½ ĞĞ¼Ğ´Ğ°Ğ»Ğ°** Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ğ¼Ğ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ ÑƒÑĞºĞ¾Ñ€ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ Ñ‡Ğ°ÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹:

```
                    1
Speedup = â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          (1 - P) + P/S

P = Ğ´Ğ¾Ğ»Ñ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸ Ğ² Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€ÑƒĞµĞ¼Ğ¾Ğ¹ Ñ‡Ğ°ÑÑ‚Ğ¸
S = ÑƒÑĞºĞ¾Ñ€ĞµĞ½Ğ¸Ğµ ÑÑ‚Ğ¾Ğ¹ Ñ‡Ğ°ÑÑ‚Ğ¸
```

**ĞŸÑ€Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ²Ñ‹Ğ²Ğ¾Ğ´:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Ğ—ĞĞšĞĞ ĞĞœĞ”ĞĞ›Ğ: ĞŸĞ ĞĞšĞ¢Ğ˜ĞšĞ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚   Ğ•ÑĞ»Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ 50% Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸:                        â”‚
â”‚   - Ğ£ÑĞºĞ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ² 2x â†’ Ğ¾Ğ±Ñ‰ĞµĞµ ÑƒÑĞºĞ¾Ñ€ĞµĞ½Ğ¸Ğµ 1.33x                   â”‚
â”‚   - Ğ£ÑĞºĞ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ² 10x â†’ Ğ¾Ğ±Ñ‰ĞµĞµ ÑƒÑĞºĞ¾Ñ€ĞµĞ½Ğ¸Ğµ 1.82x                  â”‚
â”‚   - Ğ£ÑĞºĞ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ² âˆx â†’ Ğ¾Ğ±Ñ‰ĞµĞµ ÑƒÑĞºĞ¾Ñ€ĞµĞ½Ğ¸Ğµ 2x (Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼!)          â”‚
â”‚                                                              â”‚
â”‚   Ğ•ÑĞ»Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ 10% Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸:                        â”‚
â”‚   - Ğ£ÑĞºĞ¾Ñ€Ğ¸Ñ‚ÑŒ Ğ² 10x â†’ Ğ¾Ğ±Ñ‰ĞµĞµ ÑƒÑĞºĞ¾Ñ€ĞµĞ½Ğ¸Ğµ 1.1x                   â”‚
â”‚   - ĞĞµ ÑÑ‚Ğ¾Ğ¸Ñ‚ Ñ‚Ñ€Ğ°Ñ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ€ĞµĞ¼Ñ Ğ½Ğ° ÑÑ‚Ñƒ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ!                  â”‚
â”‚                                                              â”‚
â”‚   âš ï¸ Ğ’Ñ‹Ğ²Ğ¾Ğ´: ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€ÑƒĞ¹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ hot paths (>20% Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸)     â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ĞšĞ°Ğº Ğ½Ğ°Ğ¹Ñ‚Ğ¸ hot paths:**

```bash
go tool pprof -http=:8080 cpu.prof
# Ğ’ Flame Graph: ÑĞ°Ğ¼Ñ‹Ğµ ÑˆĞ¸Ñ€Ğ¾ĞºĞ¸Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸ = hot paths
```

### 4.2 ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ¾Ğ²Ñ‹Ñ… Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¹

#### ĞšĞ¾Ğ½ĞºĞ°Ñ‚ĞµĞ½Ğ°Ñ†Ğ¸Ñ ÑÑ‚Ñ€Ğ¾Ğº

```go
// âŒ ĞÑ‡ĞµĞ½ÑŒ Ğ¿Ğ»Ğ¾Ñ…Ğ¾: O(nÂ²) â€” ĞºĞ°Ğ¶Ğ´Ğ°Ñ Ğ¸Ñ‚ĞµÑ€Ğ°Ñ†Ğ¸Ñ ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ Ğ½Ğ¾Ğ²ÑƒÑ ÑÑ‚Ñ€Ğ¾ĞºÑƒ
func buildSlow(items []string) string {
    result := ""
    for _, s := range items {
        result += s  // ĞĞ¾Ğ²Ğ°Ñ Ğ°Ğ»Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ñ€Ğ°Ğ·!
    }
    return result
}

// âœ… Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾: strings.Builder (O(n), amortized)
func buildFast(items []string) string {
    var b strings.Builder

    // ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾: Ğ¿Ñ€ĞµĞ´Ğ²Ğ°Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€Ğ°
    size := 0
    for _, s := range items {
        size += len(s)
    }
    b.Grow(size)  // ĞĞ´Ğ½Ğ° Ğ°Ğ»Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ

    for _, s := range items {
        b.WriteString(s)
    }
    return b.String()
}

// âœ… ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ°: strings.Join (ĞµÑĞ»Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ ĞºĞ¾Ğ½ĞºĞ°Ñ‚ĞµĞ½Ğ°Ñ†Ğ¸Ñ)
func buildJoin(items []string) string {
    return strings.Join(items, "")
}
```

**Benchmark:**
```
BenchmarkBuildSlow-8     10000     150234 ns/op    530192 B/op    999 allocs/op
BenchmarkBuildFast-8   1000000       1234 ns/op      4096 B/op      1 allocs/op
BenchmarkBuildJoin-8   1000000       1156 ns/op      4096 B/op      1 allocs/op
```

#### Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ C#

```csharp
// C# â€” Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ°
string result = "";
foreach (var s in items)
{
    result += s;  // âŒ ĞŸĞ»Ğ¾Ñ…Ğ¾
}

// C# â€” StringBuilder
var sb = new StringBuilder();
foreach (var s in items)
{
    sb.Append(s);  // âœ… Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾
}
return sb.ToString();
```

**Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ:**
| Go | C# |
|----|-----|
| `strings.Builder` | `StringBuilder` |
| `.WriteString()` | `.Append()` |
| `.Grow(n)` | `.EnsureCapacity(n)` |
| `.String()` | `.ToString()` |

### 4.3 ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ JSON

JSON serialization â€” Ñ‡Ğ°ÑÑ‚Ñ‹Ğ¹ bottleneck Ğ² HTTP ÑĞµÑ€Ğ²Ğ¸ÑĞ°Ñ….

#### Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ°Ñ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ°

```go
import "encoding/json"

// Ğ Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚, Ğ½Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ reflection
func handleRequest(w http.ResponseWriter, r *http.Request) {
    var req Request
    json.NewDecoder(r.Body).Decode(&req)  // Reflection

    resp := process(req)
    json.NewEncoder(w).Encode(resp)  // Reflection
}
```

#### ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ñ‹ (Ğ¿Ğ¾ ÑĞºĞ¾Ñ€Ğ¾ÑÑ‚Ğ¸)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Ğ¡Ğ ĞĞ’ĞĞ•ĞĞ˜Ğ• JSON Ğ‘Ğ˜Ğ‘Ğ›Ğ˜ĞĞ¢Ğ•Ğš                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚   Ğ‘Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ°       â”‚ Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ â”‚ ĞĞ»Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¸ â”‚ ĞÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸     â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚
â”‚   encoding/json    â”‚    1x    â”‚  ĞœĞ½Ğ¾Ğ³Ğ¾    â”‚ Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ°Ñ     â”‚
â”‚   json-iterator    â”‚   3-5x   â”‚  ĞœĞµĞ½ÑŒÑˆĞµ   â”‚ Drop-in         â”‚
â”‚   goccy/go-json    â”‚   3-5x   â”‚  ĞœĞµĞ½ÑŒÑˆĞµ   â”‚ Drop-in         â”‚
â”‚   easyjson         â”‚   5-7x   â”‚  ĞœĞ°Ğ»Ğ¾     â”‚ Code generation â”‚
â”‚   sonic            â”‚  10-15x  â”‚  ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼  â”‚ SIMD, code gen  â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### easyjson â€” code generation

```bash
# Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ°
go install github.com/mailru/easyjson/...@latest

# Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ (Ğ´Ğ»Ñ Ñ„Ğ°Ğ¹Ğ»Ğ° Ñ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼Ğ¸)
easyjson -all types.go
```

```go
// types.go
type Request struct {
    UserID   int64  `json:"user_id"`
    Action   string `json:"action"`
    Payload  []byte `json:"payload"`
}

// ĞŸĞ¾ÑĞ»Ğµ easyjson -all types.go ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ types_easyjson.go
// Ñ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ°Ğ¼Ğ¸ MarshalEasyJSON / UnmarshalEasyJSON
```

```go
// Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
import "github.com/mailru/easyjson"

func handleRequestFast(w http.ResponseWriter, r *http.Request) {
    var req Request
    easyjson.UnmarshalFromReader(r.Body, &req)  // Ğ‘ĞµĞ· reflection

    resp := process(req)
    easyjson.MarshalToWriter(resp, w)  // Ğ‘ĞµĞ· reflection
}
```

#### Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ C#

```csharp
// C# â€” System.Text.Json (Ñ source generators)
[JsonSerializable(typeof(Request))]
public partial class JsonContext : JsonSerializerContext { }

// Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ (Ğ±ĞµĞ· reflection)
var req = JsonSerializer.Deserialize(json, JsonContext.Default.Request);
```

| Go | C# |
|----|-----|
| `easyjson` (code gen) | `System.Text.Json` + source generators |
| `encoding/json` (reflection) | `Newtonsoft.Json` (reflection) |

### 4.4 Ğ˜Ğ·Ğ±ĞµĞ³Ğ°Ğ½Ğ¸Ğµ interface{} Ğ² hot paths

`interface{}` (Ğ¸Ğ»Ğ¸ `any` Ğ² Go 1.18+) Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ boxing/unboxing Ğ¸ Ğ½Ğµ Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµÑ‚ ĞºĞ¾Ğ¼Ğ¿Ğ¸Ğ»ÑÑ‚Ğ¾Ñ€Ñƒ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ.

```go
// âŒ ĞŸĞ»Ğ¾Ñ…Ğ¾: interface{} Ğ² hot path
func processSlow(items []interface{}) int {
    sum := 0
    for _, item := range items {
        // Type assertion Ğ² ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ Ğ¸Ñ‚ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸
        if v, ok := item.(int); ok {
            sum += v
        }
    }
    return sum
}

// âœ… Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾: generics (Go 1.18+)
func processFast[T constraints.Integer](items []T) T {
    var sum T
    for _, item := range items {
        sum += item  // Ğ‘ĞµĞ· type assertion
    }
    return sum
}

// âœ… Ğ˜Ğ»Ğ¸: ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğ¹ Ñ‚Ğ¸Ğ¿
func processInts(items []int) int {
    sum := 0
    for _, item := range items {
        sum += item
    }
    return sum
}
```

**Benchmark:**
```
BenchmarkProcessInterface-8    5000000    312 ns/op    80 B/op    5 allocs/op
BenchmarkProcessGeneric-8     50000000     24 ns/op     0 B/op    0 allocs/op
BenchmarkProcessInts-8        50000000     23 ns/op     0 B/op    0 allocs/op
```

#### Type switch ĞºĞ°Ğº Ğ°Ğ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ°

```go
// ĞšĞ¾Ğ³Ğ´Ğ° Ñ‚Ğ¸Ğ¿Ğ¾Ğ² Ğ½ĞµĞ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ¸ Ğ¾Ğ½Ğ¸ Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹ Ğ·Ğ°Ñ€Ğ°Ğ½ĞµĞµ
func processKnownTypes(v interface{}) int {
    switch x := v.(type) {
    case int:
        return x * 2
    case int64:
        return int(x * 2)
    case string:
        return len(x)
    default:
        return 0
    }
}
```

### 4.5 Preallocations Ğ¸ Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

#### Preallocation ÑĞ»Ğ°Ğ¹ÑĞ¾Ğ²

```go
// âŒ ĞŸĞ»Ğ¾Ñ…Ğ¾: Ğ¼Ğ½Ğ¾Ğ³Ğ¾ reallocations
func collectBad(n int) []int {
    var result []int  // len=0, cap=0
    for i := 0; i < n; i++ {
        result = append(result, compute(i))  // Grow: 0â†’1â†’2â†’4â†’8â†’16â†’...
    }
    return result
}

// âœ… Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾: Ğ¾Ğ´Ğ½Ğ° Ğ°Ğ»Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ
func collectGood(n int) []int {
    result := make([]int, 0, n)  // len=0, cap=n
    for i := 0; i < n; i++ {
        result = append(result, compute(i))  // No reallocation
    }
    return result
}

// âœ… Ğ•Ñ‰Ñ‘ Ğ»ÑƒÑ‡ÑˆĞµ, ĞµÑĞ»Ğ¸ Ğ¸Ğ½Ğ´ĞµĞºÑ Ğ¸Ğ·Ğ²ĞµÑÑ‚ĞµĞ½
func collectBest(n int) []int {
    result := make([]int, n)  // len=n, cap=n
    for i := 0; i < n; i++ {
        result[i] = compute(i)  // Direct assignment
    }
    return result
}
```

#### Preallocation maps

```go
// âŒ ĞŸĞ»Ğ¾Ñ…Ğ¾: Ğ¼Ğ½Ğ¾Ğ³Ğ¾ rehashing
func buildMapBad(items []Item) map[string]Item {
    result := make(map[string]Item)  // ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
    for _, item := range items {
        result[item.ID] = item  // Rehash Ğ¿Ñ€Ğ¸ Ñ€Ğ¾ÑÑ‚Ğµ
    }
    return result
}

// âœ… Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ¾: Ğ¾Ğ´Ğ½Ğ° Ğ°Ğ»Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ
func buildMapGood(items []Item) map[string]Item {
    result := make(map[string]Item, len(items))  // Ğ¢Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€
    for _, item := range items {
        result[item.ID] = item  // No rehashing
    }
    return result
}
```

#### sync.Pool Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµĞ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ

```go
// ĞŸÑƒĞ» Ğ±ÑƒÑ„ĞµÑ€Ğ¾Ğ² Ğ´Ğ»Ñ JSON encoding
var bufferPool = sync.Pool{
    New: func() interface{} {
        return new(bytes.Buffer)
    },
}

func encodeJSON(v interface{}) ([]byte, error) {
    buf := bufferPool.Get().(*bytes.Buffer)
    buf.Reset()  // Ğ’Ğ°Ğ¶Ğ½Ğ¾: Ğ¾Ñ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿ĞµÑ€ĞµĞ´ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼
    defer bufferPool.Put(buf)

    err := json.NewEncoder(buf).Encode(v)
    if err != nil {
        return nil, err
    }

    // ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼, Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼Ñƒ Ñ‡Ñ‚Ğ¾ Ğ±ÑƒÑ„ĞµÑ€ Ğ²ĞµÑ€Ğ½Ñ‘Ñ‚ÑÑ Ğ² Ğ¿ÑƒĞ»
    result := make([]byte, buf.Len())
    copy(result, buf.Bytes())
    return result, nil
}
```

> ğŸ’¡ **ĞŸĞ¾Ğ´Ñ€Ğ¾Ğ±Ğ½ĞµĞµ Ğ¾ sync.Pool**: [Ğ Ğ°Ğ·Ğ´ĞµĞ» 2.3 (GC)](./03_gc.md)

#### Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ C#

| Go | C# |
|----|-----|
| `make([]T, 0, n)` | `new List<T>(capacity: n)` |
| `make(map[K]V, n)` | `new Dictionary<K,V>(capacity: n)` |
| `sync.Pool` | `ObjectPool<T>` (Microsoft.Extensions.ObjectPool) |
| `[]byte` buffer reuse | `ArrayPool<byte>.Shared` |

```csharp
// C# ÑĞºĞ²Ğ¸Ğ²Ğ°Ğ»ĞµĞ½Ñ‚ sync.Pool
var pool = ArrayPool<byte>.Shared;
byte[] buffer = pool.Rent(1024);
try
{
    // Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ buffer
}
finally
{
    pool.Return(buffer);
}
```

---

## 5. Continuous Profiling

Continuous Profiling â€” ÑÑ‚Ğ¾ Ğ¿Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ñ‹Ğ¹ ÑĞ±Ğ¾Ñ€ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ĞµĞ¹ Ğ² production Ğ´Ğ»Ñ Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸.

### 5.1 ĞšĞ¾Ğ½Ñ†ĞµĞ¿Ñ†Ğ¸Ñ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CONTINUOUS PROFILING: ĞšĞĞĞ¦Ğ•ĞŸĞ¦Ğ˜Ğ¯                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Ğ¢Ñ€Ğ°Ğ´Ğ¸Ñ†Ğ¸Ğ¾Ğ½Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ:                                  â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚   1. Ğ—Ğ°Ğ¼ĞµÑ‚Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñƒ                                          â”‚
â”‚   2. ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ğ»Ğ¸ÑÑŒ Ğº production                                  â”‚
â”‚   3. Ğ¡Ğ¾Ğ±Ñ€Ğ°Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ                                            â”‚
â”‚   4. ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ° ÑƒĞ¶Ğµ Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ°... ğŸ˜                                  â”‚
â”‚                                                                  â”‚
â”‚   Continuous Profiling:                                         â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                         â”‚
â”‚   â€¢ ĞŸĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ñ‹Ğ¹ ÑĞ±Ğ¾Ñ€ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ĞµĞ¹ (CPU, memory, goroutines)          â”‚
â”‚   â€¢ ĞĞ³Ñ€ĞµĞ³Ğ°Ñ†Ğ¸Ñ Ğ¸ Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ¸                             â”‚
â”‚   â€¢ ĞœĞ¾Ğ¶Ğ½Ğ¾ "Ğ²ĞµÑ€Ğ½ÑƒÑ‚ÑŒÑÑ Ğ² Ğ¿Ñ€Ğ¾ÑˆĞ»Ğ¾Ğµ" Ğ¸ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ, Ñ‡Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ğ»Ğ¾      â”‚
â”‚   â€¢ Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ğ²ĞµÑ€ÑĞ¸Ğ¹: v1.2.3 vs v1.2.4                          â”‚
â”‚   â€¢ Alerts Ğ½Ğ° Ğ°Ğ½Ğ¾Ğ¼Ğ°Ğ»Ğ¸Ğ¸                                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ°:**
- **Ğ ĞµÑ‚Ñ€Ğ¾ÑĞ¿ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·** â€” Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ğ½Ğ° Ğ¼Ğ¾Ğ¼ĞµĞ½Ñ‚ Ğ¸Ğ½Ñ†Ğ¸Ğ´ĞµĞ½Ñ‚Ğ°
- **Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ğ²ĞµÑ€ÑĞ¸Ğ¹** â€” Ğ½Ğ¾Ğ²Ğ°Ñ Ğ²ĞµÑ€ÑĞ¸Ñ ÑÑ‚Ğ°Ğ»Ğ° Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½ĞµĞµ?
- **Ğ¢Ñ€ĞµĞ½Ğ´Ñ‹** â€” Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ´ĞµĞ³Ñ€Ğ°Ğ´Ğ¸Ñ€ÑƒĞµÑ‚ ÑĞ¾ Ğ²Ñ€ĞµĞ¼ĞµĞ½ĞµĞ¼?
- **ĞšĞ¾Ñ€Ñ€ĞµĞ»ÑÑ†Ğ¸Ñ** â€” ÑĞ²ÑĞ·Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ñ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ°Ğ¼Ğ¸ Ğ¸ Ğ»Ğ¾Ğ³Ğ°Ğ¼Ğ¸

### 5.2 Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ñ‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Ğ˜ĞĞ¡Ğ¢Ğ Ğ£ĞœĞ•ĞĞ¢Ğ« CONTINUOUS PROFILING                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   Ğ˜Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚          â”‚ Ğ¢Ğ¸Ğ¿          â”‚ Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ                â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚   Pyroscope           â”‚ Open-source  â”‚ Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾ (self-hosted)  â”‚
â”‚   Grafana Phlare      â”‚ Open-source  â”‚ Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾ (self-hosted)  â”‚
â”‚   Google Cloud        â”‚ Cloud        â”‚ $5/agent/month           â”‚
â”‚     Profiler          â”‚              â”‚                          â”‚
â”‚   Datadog             â”‚ Cloud        â”‚ Ğ’ĞºĞ»ÑÑ‡ĞµĞ½Ğ¾ Ğ² APM Ğ¿Ğ»Ğ°Ğ½      â”‚
â”‚     Profiler          â”‚              â”‚                          â”‚
â”‚   Polar Signals       â”‚ Cloud/OSS    â”‚ Free tier + paid         â”‚
â”‚   Parca               â”‚ Open-source  â”‚ Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ğ¾ (self-hosted)  â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ .NET:**
| Go | .NET |
|----|------|
| Pyroscope | Application Insights Profiler |
| Datadog Profiler | Datadog .NET Profiler |
| Google Cloud Profiler | Azure Application Insights |

### 5.3 Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ Ñ Go Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ĞµĞ¼

#### Pyroscope (Open Source)

```go
package main

import (
    "github.com/grafana/pyroscope-go"
)

func main() {
    // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Pyroscope
    pyroscope.Start(pyroscope.Config{
        ApplicationName: "my-service",
        ServerAddress:   "http://pyroscope:4040",

        // Ğ¢Ğ¸Ğ¿Ñ‹ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ĞµĞ¹ Ğ´Ğ»Ñ ÑĞ±Ğ¾Ñ€Ğ°
        ProfileTypes: []pyroscope.ProfileType{
            pyroscope.ProfileCPU,
            pyroscope.ProfileAllocObjects,
            pyroscope.ProfileAllocSpace,
            pyroscope.ProfileInuseObjects,
            pyroscope.ProfileInuseSpace,
            pyroscope.ProfileGoroutines,
        },

        // Ğ¢ĞµĞ³Ğ¸ Ğ´Ğ»Ñ Ñ„Ğ¸Ğ»ÑŒÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸
        Tags: map[string]string{
            "env":     "production",
            "version": "1.2.3",
            "region":  "us-east-1",
        },
    })

    // Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
    runApp()
}
```

**Dockerfile Ğ´Ğ»Ñ Pyroscope:**

```dockerfile
FROM golang:1.22 AS builder
WORKDIR /app
COPY . .
RUN go build -o /app/myservice

FROM gcr.io/distroless/base
COPY --from=builder /app/myservice /myservice
CMD ["/myservice"]
```

**Docker Compose:**

```yaml
version: "3.8"
services:
  pyroscope:
    image: grafana/pyroscope:latest
    ports:
      - "4040:4040"
    volumes:
      - pyroscope-data:/var/lib/pyroscope

  myservice:
    build: .
    environment:
      - PYROSCOPE_SERVER=http://pyroscope:4040
    depends_on:
      - pyroscope

volumes:
  pyroscope-data:
```

#### Google Cloud Profiler

```go
package main

import (
    "cloud.google.com/go/profiler"
    "log"
)

func main() {
    // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Cloud Profiler
    cfg := profiler.Config{
        Service:        "my-service",
        ServiceVersion: "1.2.3",
        ProjectID:      "my-gcp-project",  // ĞĞ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾, ĞµÑĞ»Ğ¸ Ğ² GCP

        // ĞĞµ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ñ‚ÑŒ MutexProfiling, Ğ¾Ğ½ Ğ²ĞºĞ»ÑÑ‡Ñ‘Ğ½ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
    }

    if err := profiler.Start(cfg); err != nil {
        log.Fatalf("Failed to start profiler: %v", err)
    }

    // Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
    runApp()
}
```

#### Datadog Continuous Profiler

```go
package main

import (
    "gopkg.in/DataDog/dd-trace-go.v1/profiler"
    "log"
)

func main() {
    // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Datadog Profiler
    err := profiler.Start(
        profiler.WithService("my-service"),
        profiler.WithEnv("production"),
        profiler.WithVersion("1.2.3"),
        profiler.WithProfileTypes(
            profiler.CPUProfile,
            profiler.HeapProfile,
            profiler.GoroutineProfile,
            profiler.MutexProfile,
            profiler.BlockProfile,
        ),
    )
    if err != nil {
        log.Fatalf("Failed to start profiler: %v", err)
    }
    defer profiler.Stop()

    // Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
    runApp()
}
```

#### Low-overhead Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

Continuous profiling Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Ñ Ğ½Ğ¸Ğ·ĞºĞ¸Ğ¼ overhead (~1-5%):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              OVERHEAD CONTINUOUS PROFILING                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚   ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ         â”‚ Overhead â”‚ Ğ§Ğ°ÑÑ‚Ğ¾Ñ‚Ğ° ÑĞ±Ğ¾Ñ€Ğ°                    â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚   CPU             â”‚  ~1-2%   â”‚ ĞŸĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ğ¾ (sampling 100 Hz)      â”‚
â”‚   Heap            â”‚  ~1%     â”‚ ĞšĞ°Ğ¶Ğ´Ñ‹Ğµ 10 ÑĞµĞºÑƒĞ½Ğ´                 â”‚
â”‚   Goroutines      â”‚  ~0.5%   â”‚ ĞšĞ°Ğ¶Ğ´Ñ‹Ğµ 10 ÑĞµĞºÑƒĞ½Ğ´                 â”‚
â”‚   Mutex           â”‚  ~0.5%   â”‚ ĞŸĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ğ¾ (sampling)             â”‚
â”‚   Block           â”‚  ~1%     â”‚ ĞŸĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ğ¾ (sampling)             â”‚
â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚   Ğ˜Ğ¢ĞĞ“Ğ           â”‚  ~3-5%   â”‚ ĞŸÑ€Ğ¸ĞµĞ¼Ğ»ĞµĞ¼Ğ¾ Ğ´Ğ»Ñ production         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ĞŸÑ€Ğ°ĞºÑ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ñ‹

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 1: ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ HTTP ÑĞµÑ€Ğ²Ğ¸ÑĞ° (end-to-end)

**Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹:** HTTP ÑĞµÑ€Ğ²Ğ¸Ñ Ñ Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ğ¼ latency Ğ½Ğ° endpoint `/api/users`.

#### Ğ¨Ğ°Ğ³ 1: Ğ’Ğ¾ÑĞ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ¸ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñƒ

```go
// main.go
package main

import (
    "encoding/json"
    "net/http"
    _ "net/http/pprof"  // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ pprof
)

type User struct {
    ID       int64    `json:"id"`
    Name     string   `json:"name"`
    Email    string   `json:"email"`
    Tags     []string `json:"tags"`
    Metadata string   `json:"metadata"`
}

func getUsers(w http.ResponseWriter, r *http.Request) {
    users := loadUsers()  // Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¸Ğ· Ğ‘Ğ”

    // ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´: ÑÑ‚Ñ€Ğ¾Ğ¸Ğ¼ JSON Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ½ĞµÑÑ„Ñ„ĞµĞºÑ‚Ğ¸Ğ²Ğ½Ğ¾
    var result string
    for _, u := range users {
        data, _ := json.Marshal(u)
        result += string(data) + ","  // âŒ ĞšĞ¾Ğ½ĞºĞ°Ñ‚ĞµĞ½Ğ°Ñ†Ğ¸Ñ ÑÑ‚Ñ€Ğ¾Ğº
    }
    result = "[" + result[:len(result)-1] + "]"

    w.Header().Set("Content-Type", "application/json")
    w.Write([]byte(result))
}

func main() {
    // pprof Ğ½Ğ° Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¼ Ğ¿Ğ¾Ñ€Ñ‚Ñƒ
    go func() {
        http.ListenAndServe("localhost:6060", nil)
    }()

    mux := http.NewServeMux()
    mux.HandleFunc("/api/users", getUsers)
    http.ListenAndServe(":8080", mux)
}
```

#### Ğ¨Ğ°Ğ³ 2: Benchmark

```go
// main_test.go
package main

import (
    "net/http"
    "net/http/httptest"
    "testing"
)

func BenchmarkGetUsers(b *testing.B) {
    req := httptest.NewRequest("GET", "/api/users", nil)

    for i := 0; i < b.N; i++ {
        w := httptest.NewRecorder()
        getUsers(w, req)
    }
}
```

```bash
# Ğ—Ğ°Ğ¿ÑƒÑĞº benchmark Ñ CPU Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ĞµĞ¼
go test -bench=BenchmarkGetUsers -count=10 -cpuprofile=cpu.prof > before.txt
```

#### Ğ¨Ğ°Ğ³ 3: ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ñ

```bash
go tool pprof -http=:8080 cpu.prof
```

**Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°:**

```
Showing top 10 nodes out of 43
      flat  flat%   sum%        cum   cum%
     2.5s 35.00% 35.00%      2.5s 35.00%  runtime.mallocgc      â† ĞœĞ½Ğ¾Ğ³Ğ¾ Ğ°Ğ»Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¹!
     1.5s 21.00% 56.00%      1.5s 21.00%  runtime.memmove       â† ĞšĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
     1.0s 14.00% 70.00%      4.0s 56.00%  main.getUsers         â† ĞĞ°Ñˆ handler
     0.5s  7.00% 77.00%      0.5s  7.00%  encoding/json.Marshal
```

**Ğ’Ñ‹Ğ²Ğ¾Ğ´:** ĞœĞ½Ğ¾Ğ³Ğ¾ Ğ°Ğ»Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¹ (`mallocgc`) Ğ¸ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ (`memmove`) â€” Ñ‚Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ğ¾ Ğ´Ğ»Ñ ĞºĞ¾Ğ½ĞºĞ°Ñ‚ĞµĞ½Ğ°Ñ†Ğ¸Ğ¸ ÑÑ‚Ñ€Ğ¾Ğº.

#### Ğ¨Ğ°Ğ³ 4: ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

```go
func getUsersOptimized(w http.ResponseWriter, r *http.Request) {
    users := loadUsers()

    w.Header().Set("Content-Type", "application/json")

    // âœ… Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ json.Encoder Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ÑƒÑ â€” Ğ½Ğ¸ĞºĞ°ĞºĞ¾Ğ¹ ĞºĞ¾Ğ½ĞºĞ°Ñ‚ĞµĞ½Ğ°Ñ†Ğ¸Ğ¸
    json.NewEncoder(w).Encode(users)
}
```

**Ğ•Ñ‰Ñ‘ Ğ»ÑƒÑ‡ÑˆĞµ Ñ easyjson:**

```go
//go:generate easyjson -all main.go

func getUsersFast(w http.ResponseWriter, r *http.Request) {
    users := loadUsers()

    w.Header().Set("Content-Type", "application/json")

    // âœ… easyjson â€” Ğ±ĞµĞ· reflection
    out, _ := easyjson.Marshal(users)
    w.Write(out)
}
```

#### Ğ¨Ğ°Ğ³ 5: Ğ’ĞµÑ€Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ

```bash
go test -bench=BenchmarkGetUsers -count=10 > after.txt
benchstat before.txt after.txt
```

**Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚:**
```
name          old time/op    new time/op    delta
GetUsers-8      15.2ms Â± 2%     1.2ms Â± 3%   -92.1%  (p=0.000 n=10+10)

name          old alloc/op   new alloc/op   delta
GetUsers-8      4.52MB Â± 0%    0.12MB Â± 0%   -97.3%  (p=0.000 n=10+10)

name          old allocs/op  new allocs/op  delta
GetUsers-8       45.2k Â± 0%      0.5k Â± 0%   -98.9%  (p=0.000 n=10+10)
```

---

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 2: Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° memory leak Ñ‡ĞµÑ€ĞµĞ· goroutine leak

**Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹:** ĞŸĞ°Ğ¼ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ğ¿Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ğ¾ Ñ€Ğ°ÑÑ‚Ñ‘Ñ‚.

#### Ğ¡Ğ¸Ğ¼Ğ¿Ñ‚Ğ¾Ğ¼Ñ‹

```bash
# ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸
watch -n 5 'curl -s localhost:6060/debug/pprof/heap | head -20'

# Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚: Ğ¿Ğ°Ğ¼ÑÑ‚ÑŒ Ñ€Ğ°ÑÑ‚Ñ‘Ñ‚ Ğ½Ğ° ~10MB ĞºĞ°Ğ¶Ğ´ÑƒÑ Ğ¼Ğ¸Ğ½ÑƒÑ‚Ñƒ
```

#### Ğ¨Ğ°Ğ³ 1: ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½

```bash
# ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½
curl -s localhost:6060/debug/pprof/goroutine | head -1
# goroutine profile: total 15234  â† ĞŸĞ¾Ğ´Ğ¾Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ¼Ğ½Ğ¾Ğ³Ğ¾!

# Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ
go tool pprof http://localhost:6060/debug/pprof/goroutine
```

```
(pprof) top
Showing nodes accounting for 15000, 98.5% of 15234 total
      flat  flat%   sum%        cum   cum%
     15000 98.5% 98.5%      15000 98.5%  main.processRequest
```

#### Ğ¨Ğ°Ğ³ 2: ĞĞ½Ğ°Ğ»Ğ¸Ğ· ĞºĞ¾Ğ´Ğ°

```go
// ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´
func processRequest(ctx context.Context, data Data) {
    // Ğ“Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ğ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ, Ğ½Ğ¾ Ğ½Ğ¸ĞºĞ¾Ğ³Ğ´Ğ° Ğ½Ğµ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ°ĞµÑ‚ÑÑ
    go func() {
        for {
            result := heavyComputation(data)
            sendToChannel(result)  // â† ĞšĞ°Ğ½Ğ°Ğ» Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½, Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ğ° Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ÑÑ
        }
    }()
}

// ĞšĞ°Ğ½Ğ°Ğ» Ğ½Ğ¸ĞºĞ¾Ğ³Ğ´Ğ° Ğ½Ğµ Ñ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿ĞµÑ€Ğ²Ñ‹Ñ… N ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
var resultChan = make(chan Result, 100)

func init() {
    go func() {
        for i := 0; i < 100; i++ {
            <-resultChan  // Ğ§Ğ¸Ñ‚Ğ°ĞµĞ¼ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ 100 ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²
        }
        // Ğ‘Ğ¾Ğ»ÑŒÑˆĞµ Ğ½Ğµ Ñ‡Ğ¸Ñ‚Ğ°ĞµĞ¼ â€” Ğ²ÑĞµ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒÑÑ‚ÑÑ Ğ½Ğ° send
    }()
}
```

#### Ğ¨Ğ°Ğ³ 3: Ğ˜ÑĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ

```go
func processRequestFixed(ctx context.Context, data Data) {
    go func() {
        for {
            select {
            case <-ctx.Done():
                return  // âœ… Ğ’Ñ‹Ñ…Ğ¾Ğ´ Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¼ĞµĞ½Ğµ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ°
            default:
                result := heavyComputation(data)
                select {
                case resultChan <- result:
                    // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾
                case <-ctx.Done():
                    return  // âœ… Ğ’Ñ‹Ñ…Ğ¾Ğ´ ĞµÑĞ»Ğ¸ ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ Ğ¾Ñ‚Ğ¼ĞµĞ½Ñ‘Ğ½
                case <-time.After(time.Second):
                    // âœ… Ğ¢Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚ â€” Ğ½Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµĞ¼ÑÑ Ğ½Ğ°Ğ²ĞµÑ‡Ğ½Ğ¾
                    log.Warn("channel full, dropping result")
                }
            }
        }
    }()
}
```

#### Ğ¨Ğ°Ğ³ 4: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ goleak Ğ² Ñ‚ĞµÑÑ‚Ğ°Ñ…

```go
import "go.uber.org/goleak"

func TestMain(m *testing.M) {
    goleak.VerifyTestMain(m)
}

func TestProcessRequest(t *testing.T) {
    ctx, cancel := context.WithTimeout(context.Background(), time.Second)
    defer cancel()

    processRequestFixed(ctx, testData)

    // goleak Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ ÑƒÑ‚ĞµÑ‡ĞºĞ¸ Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½
}
```

---

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 3: Latency spikes Ğ² Ğ¼Ğ¸ĞºÑ€Ğ¾ÑĞµÑ€Ğ²Ğ¸ÑĞµ

**Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹:** P99 latency = 500ms, P50 = 10ms. ĞĞ³Ñ€Ğ¾Ğ¼Ğ½Ñ‹Ğ¹ Ñ€Ğ°Ğ·Ğ±Ñ€Ğ¾Ñ.

#### Ğ¨Ğ°Ğ³ 1: Ğ¡Ğ±Ğ¾Ñ€ trace

```bash
curl -o trace.out "http://localhost:6060/debug/pprof/trace?seconds=60"
go tool trace trace.out
```

#### Ğ¨Ğ°Ğ³ 2: ĞĞ½Ğ°Ğ»Ğ¸Ğ·

Ğ’ Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ Ğ¾Ñ‚ĞºÑ€Ñ‹Ğ²Ğ°ĞµĞ¼ "Goroutine analysis":

```
Goroutine analysis:
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Goroutine Name           Count   Execution   Sync Block   GC Wait
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
main.handleRequest        1000     100ms       350ms       50ms
                                               â†‘            â†‘
                                         Mutex/Channel   GC Ğ¿Ğ°ÑƒĞ·Ñ‹
```

**Ğ’Ñ‹Ğ²Ğ¾Ğ´:**
- 350ms Ğ² "Sync Block" â€” Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ½Ğ° mutex Ğ¸Ğ»Ğ¸ channel
- 50ms Ğ² "GC Wait" â€” Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ GC

#### Ğ¨Ğ°Ğ³ 3: Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° mutex contention

```bash
# ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ mutex contention
go tool pprof http://localhost:6060/debug/pprof/mutex
```

```
(pprof) top
Showing nodes accounting for 8.5s, 85% of 10s total
      flat  flat%   sum%        cum   cum%
     8.5s 85.00% 85.00%      8.5s 85.00%  sync.(*Mutex).Lock
                                           main.getCache
```

**ĞŸÑ€Ğ¾Ğ±Ğ»ĞµĞ¼Ğ½Ñ‹Ğ¹ ĞºĞ¾Ğ´:**

```go
var (
    cacheMu sync.Mutex
    cache   = make(map[string]Value)
)

func getCache(key string) Value {
    cacheMu.Lock()  // â† Ğ’ÑĞµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ ÑĞµÑ€Ğ¸Ğ°Ğ»Ğ¸Ğ·ÑƒÑÑ‚ÑÑ Ğ·Ğ´ĞµÑÑŒ
    defer cacheMu.Unlock()
    return cache[key]
}
```

#### Ğ¨Ğ°Ğ³ 4: ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

```go
// Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ 1: RWMutex Ğ´Ğ»Ñ read-heavy workload
var (
    cacheMu sync.RWMutex
    cache   = make(map[string]Value)
)

func getCacheRW(key string) Value {
    cacheMu.RLock()  // âœ… ĞŸĞ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ‡Ñ‚ĞµĞ½Ğ¸Ñ
    defer cacheMu.RUnlock()
    return cache[key]
}

// Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ 2: Sharded cache Ğ´Ğ»Ñ high contention
type ShardedCache struct {
    shards [256]struct {
        sync.RWMutex
        data map[string]Value
    }
}

func (c *ShardedCache) Get(key string) Value {
    shard := &c.shards[hash(key)%256]
    shard.RLock()
    defer shard.RUnlock()
    return shard.data[key]
}
```

#### Ğ¨Ğ°Ğ³ 5: Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸ĞºĞ° GC

```bash
GODEBUG=gctrace=1 ./myapp 2>&1 | grep gc
```

```
gc 1 @0.012s 2%: 0.5+15+0.5 ms clock, 4+0/12/0+4 ms cpu, 100->105->50 MB
gc 2 @0.034s 3%: 0.6+18+0.6 ms clock, 5+0/15/0+5 ms cpu, 100->110->55 MB
                      â†‘
                 STW pause = 18ms â€” ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ´Ğ¾Ğ»Ğ³Ğ¾!
```

**Ğ ĞµÑˆĞµĞ½Ğ¸Ğµ:**

```go
// Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ñ‚ÑŒ GOGC (Ğ¼ĞµĞ½ÑŒÑˆĞµ GC Ñ†Ğ¸ĞºĞ»Ğ¾Ğ², Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ¿Ğ°Ğ¼ÑÑ‚Ğ¸)
// Ğ’ production Ğ¸Ğ»Ğ¸ Ñ‡ĞµÑ€ĞµĞ· Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
import "runtime/debug"

func init() {
    debug.SetGCPercent(200)  // Ğ”ĞµÑ„Ğ¾Ğ»Ñ‚ 100, ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ² 2 Ñ€Ğ°Ğ·Ğ°
}
```

---

### ĞŸÑ€Ğ¸Ğ¼ĞµÑ€ 4: CI/CD pipeline Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸

**Ğ¦ĞµĞ»ÑŒ:** ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ»Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ñ€ĞµĞ³Ñ€ĞµÑÑĞ¸Ğ¸ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚Ğ¸ Ğ² PR.

#### GitHub Actions workflow

```yaml
# .github/workflows/performance.yml
name: Performance Tests

on:
  pull_request:
    branches: [main]

jobs:
  benchmark:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ğ”Ğ»Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ Ñ main

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@latest

      - name: Run benchmarks on PR
        run: |
          go test -bench=. -count=10 -benchmem ./... > new.txt

      - name: Checkout main branch
        run: |
          git checkout main
          go test -bench=. -count=10 -benchmem ./... > old.txt
          git checkout -

      - name: Compare benchmarks
        id: compare
        run: |
          benchstat old.txt new.txt > comparison.txt
          cat comparison.txt

          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ½Ğ° Ñ€ĞµĞ³Ñ€ĞµÑÑĞ¸Ğ¸ > 10%
          if grep -E '\+[1-9][0-9]+\.[0-9]+%' comparison.txt; then
            echo "regression=true" >> $GITHUB_OUTPUT
          else
            echo "regression=false" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comparison = fs.readFileSync('comparison.txt', 'utf8');

            const body = `## Benchmark Results

            \`\`\`
            ${comparison}
            \`\`\`

            ${process.env.REGRESSION === 'true' ? 'âš ï¸ **Performance regression detected!**' : 'âœ… No significant regressions'}
            `;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
        env:
          REGRESSION: ${{ steps.compare.outputs.regression }}

      - name: Fail on regression
        if: steps.compare.outputs.regression == 'true'
        run: |
          echo "Performance regression detected!"
          exit 1
```

#### Ğ ĞµĞ·ÑƒĞ»ÑŒÑ‚Ğ°Ñ‚ Ğ² PR

```
## Benchmark Results

name              old time/op    new time/op    delta
Handler-8           1.25ms Â± 2%    1.89ms Â± 3%   +51.2%  âš ï¸

name              old alloc/op   new alloc/op   delta
Handler-8           48.2kB Â± 0%    72.1kB Â± 0%   +49.6%  âš ï¸

âš ï¸ **Performance regression detected!**
```

---

## Ğ§ĞµĞº-Ğ»Ğ¸ÑÑ‚

ĞŸĞ¾ÑĞ»Ğµ Ğ¸Ğ·ÑƒÑ‡ĞµĞ½Ğ¸Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ° Ğ²Ñ‹ Ğ´Ğ¾Ğ»Ğ¶Ğ½Ñ‹ ÑƒĞ¼ĞµÑ‚ÑŒ:

### CPU Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ
- [ ] ĞŸĞ¾Ğ´ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ `net/http/pprof` Ğº Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ
- [ ] Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°Ñ‚ÑŒ CPU Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ Ñ‡ĞµÑ€ĞµĞ· HTTP endpoint Ğ¸Ğ»Ğ¸ `go test -cpuprofile`
- [ ] ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ: `top`, `top -cum`, `list`, `web`
- [ ] Ğ˜Ğ½Ñ‚ĞµÑ€Ğ¿Ñ€ĞµÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ flame graphs
- [ ] Ğ Ğ°Ğ·Ğ»Ğ¸Ñ‡Ğ°Ñ‚ÑŒ `flat` Ğ¸ `cum` (cumulative) Ğ²Ñ€ĞµĞ¼Ñ
- [ ] ĞĞ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒ Ñ‚Ğ¸Ğ¿Ğ¸Ñ‡Ğ½Ñ‹Ğµ CPU bottlenecks (Ğ°Ğ»Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ğ¸, ÑÑ‚Ñ€Ğ¾ĞºĞ¸, JSON, mutex)

### go tool trace
- [ ] Ğ¡Ğ¾Ğ±Ğ¸Ñ€Ğ°Ñ‚ÑŒ trace Ñ‡ĞµÑ€ĞµĞ· `go test -trace` Ğ¸Ğ»Ğ¸ HTTP endpoint
- [ ] ĞĞ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Goroutine Analysis Ğ² Ğ±Ñ€Ğ°ÑƒĞ·ĞµÑ€Ğµ
- [ ] Ğ”Ğ¸Ğ°Ğ³Ğ½Ğ¾ÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ latency spikes (GC Ğ¿Ğ°ÑƒĞ·Ñ‹, mutex contention, I/O)
- [ ] Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ `trace.NewTask` Ğ¸ `trace.WithRegion` Ğ´Ğ»Ñ ÑĞ²Ğ¾Ğ¸Ñ… ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ğ¹

### Workflow Ğ¿Ñ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
- [ ] ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ğ¼ĞµÑ‚Ğ¾Ğ´Ğ¾Ğ»Ğ¾Ğ³Ğ¸Ñ: Measure â†’ Identify â†’ Optimize â†’ Verify
- [ ] Ğ’Ñ‹Ğ±Ğ¸Ñ€Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹
- [ ] Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ `benchstat` Ğ´Ğ»Ñ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ Ğ´Ğ¾/Ğ¿Ğ¾ÑĞ»Ğµ

### ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ
- [ ] ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ğ·Ğ°ĞºĞ¾Ğ½ ĞĞ¼Ğ´Ğ°Ğ»Ğ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
- [ ] ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ÑÑ‚Ñ€Ğ¾ĞºĞ¾Ğ²Ñ‹Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ (`strings.Builder`)
- [ ] ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ JSON (easyjson, sonic)
- [ ] Ğ˜Ğ·Ğ±ĞµĞ³Ğ°Ñ‚ÑŒ `interface{}` Ğ² hot paths (generics)
- [ ] Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ preallocation Ğ´Ğ»Ñ slices Ğ¸ maps

### Production
- [ ] ĞŸĞ¾Ğ½Ğ¸Ğ¼Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½Ñ†ĞµĞ¿Ñ†Ğ¸Ñ Continuous Profiling
- [ ] Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Pyroscope / Cloud Profiler / Datadog
- [ ] ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ CI/CD pipeline Ñ benchmark regression detection

### Ğ¡Ñ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ Ñ C#
- [ ] ĞŸĞ¾Ğ½Ğ¸Ğ¼Ğ°Ñ‚ÑŒ Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸: pprof â†” dotTrace, trace â†” Concurrency Visualizer
- [ ] ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ğ·Ğ½Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ· .NET: `strings.Builder` â†” `StringBuilder`, `sync.Pool` â†” `ArrayPool`

---

## Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğµ ÑˆĞ°Ğ³Ğ¸

ĞŸĞ¾Ğ·Ğ´Ñ€Ğ°Ğ²Ğ»ÑÑ! Ğ’Ñ‹ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ğ»Ğ¸ **Ğ§Ğ°ÑÑ‚ÑŒ 2: ĞŸÑ€Ğ¾Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ñ‹Ğµ Ñ‚ĞµĞ¼Ñ‹**.

Ğ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ²Ñ‹ Ğ¿Ğ¾Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚Ğµ:
- Concurrency Ğ² Go (Ğ³Ğ¾Ñ€ÑƒÑ‚Ğ¸Ğ½Ñ‹, ĞºĞ°Ğ½Ğ°Ğ»Ñ‹, ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚)
- ĞšĞ°Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚ Go Runtime Ğ¸ Ğ¿Ğ»Ğ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ñ‰Ğ¸Ğº
- Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ°Ğ¼ÑÑ‚ÑŒÑ Ğ¸ GC
- ĞŸÑ€Ğ¸Ğ¼Ğ¸Ñ‚Ğ¸Ğ²Ñ‹ ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
- Ğ˜Ğ´Ğ¸Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½ÑƒÑ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº
- Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ±ĞµĞ½Ñ‡Ğ¼Ğ°Ñ€ĞºĞ¸Ğ½Ğ³
- ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ

**ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ñ‚Ğµ Ğº [Ğ§Ğ°ÑÑ‚Ğ¸ 3: Web & API](../part3-web-api/)**, Ğ³Ğ´Ğµ Ğ¼Ñ‹ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ğ¼ ÑÑ‚Ğ¸ Ğ·Ğ½Ğ°Ğ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ñ Ğ²Ñ‹ÑĞ¾ĞºĞ¾Ğ½Ğ°Ğ³Ñ€ÑƒĞ¶ĞµĞ½Ğ½Ñ‹Ñ… Ğ²ĞµĞ±-ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ².

---

**Ğ’Ğ¾Ğ¿Ñ€Ğ¾ÑÑ‹?** ĞÑ‚ĞºÑ€Ğ¾Ğ¹ issue Ğ½Ğ° [GitHub](https://github.com/AlexandrTolstuhin/csharp-to-go/issues)

[â† ĞĞ°Ğ·Ğ°Ğ´: 2.6 Ğ¢ĞµÑÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ Ğ±ĞµĞ½Ñ‡Ğ¼Ğ°Ñ€ĞºĞ¸Ğ½Ğ³](./06_testing_benchmarking.md) | [Ğ’Ğ¿ĞµÑ€Ñ‘Ğ´: Ğ§Ğ°ÑÑ‚ÑŒ 3: Web & API â†’](../part3-web-api/)
